<!DOCTYPE html>
<html>

<head lang="en">
    <link rel="icon" href="./favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="author" content="zhy" />
    <link rel="stylesheet" href="./Content/Styles/mint.css">
    <link rel="stylesheet" href="./Content/Styles/main.css">
    <link rel="stylesheet" href="./Content/Styles/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="./Scripts/jQuery/jquery.min.js"></script>
    <script src="./Scripts/web3/web3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/merkletreejs@latest/merkletree.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keccak256@latest/keccak256.js"></script>

    <title>RWA-DA-AGE - Decentralized Asset</title>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="body-bg-black">
                <div class="navBar text-center">
                    <div class="navBar-left">
                        <a href="https://da-age.io/" target="_blank"><img src='./Content/Images/dan.png' /></a>
                    </div>
                    
                    <div class="navBar-right text-right">

                        <a href="javascript:void(0);" id="connect-wallet" class="nav-link">Connect Wallet</a>
                        
                        <span id="tribe">Quantity:0</span>

                        
                    </div>
                </div>
                <div class="fn-section-4 wf-section">
                    <div class="fn-container-grid-2">
                        <div id="w-node-_61f80125-2bc5-ec0f-c12b-cc3b5c7923ed-305ff47e" class="fn-column-center-2">
                            <h1 class="title-da-age">S5 RWA DA AGE PRESALE!</h1>
                            <p class="fn-paragraph-2">Congratulations, you are one of the lucky few who made it to our
                                WhiteList!<br />You are able to mint the RWAs at the price of
                                320USDT.<br /><br />Experience the
                                thrill of the unknown! After you mint your RWA, you will have to wait for the big reveal
                                to find out
                                which prime location and zone you have landed. With numerous prime locations to choose
                                from, the
                                exact location and zone you receive will be a surprise. So, keep your fingers crossed
                                and hope for
                                the best!u&#x27;ll receive. So, brace yourself and wish yourself the best of
                                luck!<br /><br />‍</p>
                            
                        </div>
                        <div id="w-node-_61f80125-2bc5-ec0f-c12b-cc3b5c7923f8-305ff47e" class="fn-slide-item-wrapper">
                            <img id="w-node-_61f80125-2bc5-ec0f-c12b-cc3b5c7923f9-305ff47e" 
                                src="./Content/Images/RWA-S5.jpg"
                                loading="lazy"
                                
                                alt="" class="fn-slider-image" />
                            <div id="w-node-_61f80125-2bc5-ec0f-c12b-cc3b5c7923fa-305ff47e" class="fn-slider-column">
                                <h3 class="fn-heading-3">S5 RWA Buy</h3>
                                <h5 >Buy Price:</h5><br/>
                                <h5> 320 USDT</h5>
                                <div class="fn-label-icon"></div>
                                <div class="w-container">
                                 <!--  <h5>RWA unit</h5>
                                    <div class="input-group">
                                        <button type="button" class="btn minus-btn">-</button>
                                        <input type="number" class="input-field qty-input" value="1" min="1" max="30" disabled="disabled">
                                        <button type="button"  class="btn plus-btn">+</button>
                                    </div>
                                    <br> --> 
                                </div>
                                <div class="fn-label-icon"></div>
                                <h5 >TOTAL: </h5><br/>
                                <h5 id="total">320 USDT</h5>
                                <div class="fn-label-icon"></div>
                                <button id="Buy" type="button" class="primary-button w-button" data -toggle="popover">Buy</button>
                                <p class="paragraph-7"><br />‍<br /><em class="italic-text">Ownership and Profit-Sharing: By participating in our profit-sharing model, 
                                    it is essential to understand that RWA holders do not acquire ownership rights to the physical assets involved. 
                                    The designated asset owner retains sole ownership of the assets. However, as an RWA holder, 
                                    you have the opportunity to receive profits over a duration of 8 years. 
                                    These profits enable you to partake in the earnings generated by the advertisement business, 
                                    providing a rewarding investment experience within the specified timeframe. 
                                    Please refer to the relevant agreements for comprehensive terms and conditions regarding the profit-sharing arrangement.</em></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="footer wf-section">
                    <div class="footer-container w-container">
                        <div class="w-layout-grid footer-grid">
                            <div class="footer-main-box-1"><a data-ix="logo" href="https://da-age.io/" target="_blank"
                                    class="footer-logo w-nav-brand"><img
                                        src="https://uploads-ssl.webflow.com/6421898f81ec56cd303380ec/642d5a98952aaf152d2447d9_DAAGE_sss_sss.png"
                                        width="218" alt="" class="logo" /></a>
                                <p class="paragraph large grey">Own your digital assets in the age of decentralization -
                                    with DA AGE
                                    (Starting from 2023)</p>
                            </div>
                            <ul>
                                <li>
                                    <a href="https://twitter.com/DA_AGE_EN" target="_blank" class="social-link">
                                        <img src='./Content/Images/twitter.png' width="20px" height="20px" />
                                    </a>
                                </li>
                                <li>
                                    <a href="https://discord.com/invite/DA-AGE-Global" target="_blank" class="social-link">
                                        <img src='./Content/Images/discord.png' width="20px" height="20px" />
                                    </a>
                                </li>
    
                                <li>
                                    <a href="https://www.da-age.io/" target="_blank" class="social-link">
                                        <img src='./Content/Images/home.png' width="20px" height="20px" />
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    </script>
</body>

</html>
<script type="text/javascript">

    

    




 
    
    
    
    var fee_token = {
        testnet: {
            address: "0xb35BF7873bF5e2A93FD2d35d14DAeFd186a7a489", // The address that the token is at.
            symbol: "USDT", // A ticker symbol or shorthand, up to 5 chars.
            decimals: 6, // The number of decimals in the token
            image: "https://polygonscan.com/token/images/tether_32.png", // A string url of the token logo
        },
        main: {       
            address: "0xc2132D05D31c914a87C6611C10748AEb04B58e8F", // "", // The address that the token is at.
            symbol: "USDT", // A ticker symbol or shorthand, up to 5 chars.
            decimals: 6, // The number of decimals in the token
            image: "https://polygonscan.com/token/images/tether_32.png", // A string url of the token logo
        },
    }

    var network = "main"; // network type
    var net_data_map = {
        testnet: {
            chainId: "0x13881",
            chainName: "Polygon Mumbai",
            nativeCurrency: {
                name: "MATIC",
                symbol: "MATIC",
                decimals: 18
            },
            rpcUrls: ["https://rpc.ankr.com/polygon_mumbai"],
            blockExplorerUrls: ["https://mumbai.polygonscan.com/"]
        },
        main: {
            chainId: "0x89",
            chainName: "Polygon Mainnet",
            nativeCurrency: {
                name: "MATIC",
                symbol: "MATIC",
                decimals: 18
            },
            rpcUrls: ["https://polygon-mainnet.infura.io/v3/2af986a42abb45b5bd2c4495a3e0f6dd"],
            blockExplorerUrls: ["https://polygonscan.com/"]
        }
    }

    var erc20Abi = [{ "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }];

    
    var RWAABI = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"inputs":[],"name":"ApprovalCallerNotOwnerNorApproved","type":"error"},{"inputs":[],"name":"ApprovalQueryForNonexistentToken","type":"error"},{"inputs":[],"name":"BalanceQueryForZeroAddress","type":"error"},{"inputs":[],"name":"InvalidQueryRange","type":"error"},{"inputs":[],"name":"MintERC2309QuantityExceedsLimit","type":"error"},{"inputs":[],"name":"MintToZeroAddress","type":"error"},{"inputs":[],"name":"MintZeroQuantity","type":"error"},{"inputs":[],"name":"NotCompatibleWithSpotMints","type":"error"},{"inputs":[],"name":"OwnerQueryForNonexistentToken","type":"error"},{"inputs":[],"name":"OwnershipNotInitializedForExtraData","type":"error"},{"inputs":[],"name":"SequentialMintExceedsLimit","type":"error"},{"inputs":[],"name":"SequentialUpToTooSmall","type":"error"},{"inputs":[],"name":"SpotMintTokenIdTooSmall","type":"error"},{"inputs":[],"name":"TokenAlreadyExists","type":"error"},{"inputs":[],"name":"TokenIdsNotStrictlyAscending","type":"error"},{"inputs":[],"name":"TransferCallerNotOwnerNorApproved","type":"error"},{"inputs":[],"name":"TransferFromIncorrectOwner","type":"error"},{"inputs":[],"name":"TransferToNonERC721ReceiverImplementer","type":"error"},{"inputs":[],"name":"TransferToZeroAddress","type":"error"},{"inputs":[],"name":"URIQueryForNonexistentToken","type":"error"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"approved","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"operator","type":"address"},{"indexed":false,"internalType":"bool","name":"approved","type":"bool"}],"name":"ApprovalForAll","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"uint256","name":"fromTokenId","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"toTokenId","type":"uint256"},{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"}],"name":"ConsecutiveTransfer","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"userAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"CouponTransferFrom","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"userAddress","type":"address"},{"indexed":true,"internalType":"address","name":"referrerAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"ReferrerRecorded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"userAddress","type":"address"},{"indexed":true,"internalType":"address","name":"referrerAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"ReferrerTransferFrom","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":true,"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"Erc721AMintPass","outputs":[{"internalType":"contract ERC721APayToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"approve","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"baseURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"couponAddrPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"permAddress","type":"address"}],"name":"delTheChiefaddrPerm","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"explicitOwnershipOf","outputs":[{"components":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint64","name":"startTimestamp","type":"uint64"},{"internalType":"bool","name":"burned","type":"bool"},{"internalType":"uint24","name":"extraData","type":"uint24"}],"internalType":"struct IERC721A.TokenOwnership","name":"ownership","type":"tuple"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"tokenIds","type":"uint256[]"}],"name":"explicitOwnershipsOf","outputs":[{"components":[{"internalType":"address","name":"addr","type":"address"},{"internalType":"uint64","name":"startTimestamp","type":"uint64"},{"internalType":"bool","name":"burned","type":"bool"},{"internalType":"uint24","name":"extraData","type":"uint24"}],"internalType":"struct IERC721A.TokenOwnership[]","name":"","type":"tuple[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"formalitiesAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"formalitiesPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"getApproved","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"operator","type":"address"}],"name":"isApprovedForAll","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"merkleRoot","outputs":[{"internalType":"bytes32","name":"","type":"bytes32"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"addr","type":"address"}],"name":"numberMinted","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint8","name":"count","type":"uint8"}],"name":"ownerAirdrop","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"ownerOf","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"payERC20Token","outputs":[{"internalType":"contract ERC20Token","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"_quantity","type":"uint256"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"publicMint","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"publicMintState","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"referrerChiefaddrPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerInfo","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrersSize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"},{"internalType":"bytes","name":"_data","type":"bytes"}],"name":"safeTransferFrom","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"operator","type":"address"},{"internalType":"bool","name":"approved","type":"bool"}],"name":"setApprovalForAll","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"_referrers","type":"address[]"},{"internalType":"uint256[]","name":"_amounts","type":"uint256[]"}],"name":"setBacthReferrerlSize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"_theChiefaddrs","type":"address[]"}],"name":"setBacthTheChiefaddr","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"string","name":"_newBaseURI","type":"string"}],"name":"setBaseURI","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setErc20TokenAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_Erc721A","type":"address"}],"name":"setErc721AByMintPass","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"setFormalitiesAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_publicMintState","type":"bool"}],"name":"setPublicMintState","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"setTheChiefaddrMap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"permAddress","type":"address"}],"name":"setTheChiefaddrPerm","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_wlMintState","type":"bool"}],"name":"setWlMintState","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bytes4","name":"interfaceId","type":"bytes4"}],"name":"supportsInterface","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"theChiefaddr","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"theChiefaddrPerm","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"tokenURI","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"name":"tokensOfOwner","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"uint256","name":"start","type":"uint256"},{"internalType":"uint256","name":"stop","type":"uint256"}],"name":"tokensOfOwnerIn","outputs":[{"internalType":"uint256[]","name":"","type":"uint256[]"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"result","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"tokenId","type":"uint256"}],"name":"transferFrom","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_quantity","type":"uint256"},{"internalType":"address","name":"_referrer","type":"address"}],"name":"wlMint","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"wlMintBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"wlMintState","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"wlPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}]

    var RWA = "0xc1371489DD2b8bB69C54d8e02076200D40c61405";

	var abi = [{"inputs":[],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256[]","name":"rwaIds","type":"uint256[]"},{"indexed":false,"internalType":"uint256","name":"totalPrice","type":"uint256"}],"name":"RWAPurchased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"returnAmount","type":"uint256"}],"name":"RWAReturned","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"userAddress","type":"address"},{"indexed":true,"internalType":"address","name":"referrerAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"ReferrerRecorded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"userAddress","type":"address"},{"indexed":true,"internalType":"address","name":"referrerAddress","type":"address"},{"indexed":false,"internalType":"uint256","name":"quantity","type":"uint256"}],"name":"ReferrerTransferFrom","type":"event"},{"inputs":[],"name":"Erc721ARWA","outputs":[{"internalType":"contract ERC721APayToken","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FORMALITIES_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PAYMENT_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"REFERRER_CHIEFADDR_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"RETURN_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"RETURN_TWO_PRICE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"},{"internalType":"uint256[]","name":"_tokenIds","type":"uint256[]"}],"name":"batchWithDrawRWAs","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_quantity","type":"uint256"},{"internalType":"address","name":"_referrer","type":"address"},{"internalType":"uint256[]","name":"_rwaIds","type":"uint256[]"}],"name":"buyRWA","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"buyState","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"permAddress","type":"address"}],"name":"delTheChiefaddrPerm","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256[]","name":"_rwaIds","type":"uint256[]"}],"name":"depositRWAs","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"formalitiesAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"formalitiesAddressTwo","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"payERC20Token","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"paymentAddress","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrerInfo","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"referrersSize","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"returnTwoState","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"_referrers","type":"address[]"},{"internalType":"uint256[]","name":"_amounts","type":"uint256[]"}],"name":"setBacthReferrerlSize","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address[]","name":"_theChiefaddrs","type":"address[]"}],"name":"setBacthTheChiefaddr","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_buyState","type":"bool"}],"name":"setBuyState","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"token","type":"address"}],"name":"setErc20TokenAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_Erc721A","type":"address"}],"name":"setErc721A","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"setFormalitiesAddress","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"setFormalitiesAddressTwo","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_paymentPrice","type":"uint256"}],"name":"setPaymentPrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"_retuenPrice","type":"uint256"}],"name":"setReturnPrice","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"bool","name":"_returnTwoState","type":"bool"}],"name":"setReturnTwoState","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"_addr","type":"address"}],"name":"setTheChiefaddrMap","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"permAddress","type":"address"}],"name":"setTheChiefaddrPerm","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"theChiefaddr","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"theChiefaddrPerm","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"recipient","type":"address"}],"name":"withDrawAllRWAs","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdraw","outputs":[],"stateMutability":"nonpayable","type":"function"}]
    
	var contract =  "0x0B9EAC53FB2a5A2C649558244EE480dCAF3dF1B0"// S4 "0x129C7C4733b06190cCFEe1A515e0D4b4EDAD9725" //S3 "0xc0EBD15A80313dfd3e3fd3c36c15aDFA0ffba93F";//S2 "0x291B1BD67eC8D1E194dB36d92B17823186b54F44";//0x7E1d80417f1724f5Ff050C3F84DC9A3850B6e48f  main old

    
    var mintFee = 320 * (10 ** fee_token[network].decimals); // mint fee
    const provider = window.ethereum || window.web3 || (window.bitkeep && window.bitkeep.ethereum);
    var web3 = new Web3(provider);
    var gasMultiple = 1.5;//1.5;
    var gasMultiple1 = 1.3;//1.3;

    
    var isConnect = window.localStorage.getItem("selectedWallet");
    var feeContract = new web3.eth.Contract(erc20Abi, fee_token[network].address);
    var walletPlaceholderText = "Connect Wallet";
    // Proxy 定义保持不变
var wallet = new Proxy({ address: walletPlaceholderText }, {
    set(obj, prop, value) {
        if (prop === "address") {
            if (value && value !== walletPlaceholderText) {
                $("#connect-wallet").html(`${value.slice(0, 5)}...${value.slice(-5)}`);
            } else {
                $("#connect-wallet").html(walletPlaceholderText);
                location.reload(true);
            }
        }
        if (prop === "chainId") {
            if (value !== net_data_map[network].chainId) {
                if (["0x1", "0x2", "0x3", "0x4", "0x5"].includes(net_data_map[network].chainId)) {
                    window.ethereum.request({
                        method: "wallet_switchEthereumChain",
                        params: [{ chainId: net_data_map[network].chainId }]
                    });
                } else {
                    window.ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [net_data_map[network], wallet.address]
                    })
                        .then(() => {})
                        .catch(() => {});
                }
            }
        }
        obj[prop] = value;
    }
});

// 连接钱包函数
function connectWallet(provider) {
    provider.enable()
        .then(async (accounts) => {
            // 设置钱包地址和链 ID
            wallet.address = accounts[0];
            wallet.chainId = provider.chainId;
            window.localStorage.setItem("selectedWallet", "INJECTED");
            console.log('用户登录', 'wallet.address:', wallet.address);

            if (!wallet.address) {
                throw new Error("Wallet address is undefined after connection");
            }

            const type = await addresIsAffiliateList(wallet.address);
            console.log('type:', type);

            if (type) {
                console.log("wallet.address = " + wallet.address);
                document.getElementById("tribe").style.display = "inline-block";
                try {
                    await getReferralSize(wallet.address);
                } catch (error) {
                    console.error("Error in getReferralSize:", error);
                }
            }

            // 获取推荐人信息
            const ref = getQueryString("ref");
            console.log('ref:', ref);
            if (!isNotEmptyStr(ref)) {
                throw new Error("Affiliate cannot be null");
            }

            const addressRef = await queryAddressQuota(ref);
            console.log('addressRef:', addressRef);
            if (!addressRef?.data) {
                throw new Error("Invalid affiliate address");
            }
            const finalRef = addressRef.data.ref;
            console.log('finalRef:', finalRef);

            const franchiseBuyAward = await queryFranchiseBuyAward(finalRef);
            console.log('franchiseBuyAward:', franchiseBuyAward);
            if (!franchiseBuyAward?.data) {
                throw new Error("Invalid affiliate address");
            }

            // 处理 rwaIds 并更新 total
            const rwaIds = franchiseBuyAward.data.buyRWAId
                .trim()
                .split(',')
                .map(id => Number(id));
            console.log('rwaIds:', rwaIds);
            if (rwaIds.length === 0) {
                throw new Error("No valid RWA IDs found");
            }

            console.log('用户登录..');
            // 更新 total 文本
            setTotal(rwaIds.length);
        })
        .catch(error => {
            console.error("Error connecting wallet:", error);
        });
}

// 更新 total 元素的函数
function setTotal(value) {
    const totalElement = document.getElementById("total");
    if (totalElement) {
        const newValue = 320 * value;
        totalElement.innerHTML = `${newValue} USDT`;
    } else {
        console.error("Element with id 'total' not found in the DOM");
    }
}
// 事件监听保持不变
provider.on("accountsChanged", (accounts) => {
    wallet.address = accounts[0] || walletPlaceholderText;
});

provider.on('disconnect', () => {
    wallet.address = walletPlaceholderText;
});

provider.on('chainChanged', (chainId) => {
    wallet.chainId = chainId;
    connectWallet(provider);
});

document.getElementById("connect-wallet").addEventListener("click", () => connectWallet(provider));


   async function getReferralSize(address){
        try {
            
            const contractQuery = new web3.eth.Contract(abi, contract);

            var result = 0;
            
            result = await contractQuery.methods.referrersSize(address).call();

        /*    
           var snapshotSize = quantitySnapshotSizeMap.get(address.toUpperCase());

            if (typeof snapshotSize === 'number') {
                result = parseInt(result) + parseInt(snapshotSize);
            }
		*/
            var sum = result;
            console.log('sum = ' +sum);
            document.getElementById("tribe").innerText = "Quantity:" + sum;

            return result;
            
           
        } catch (err) {
            console.log(err);
        }
    }


    const showToast = (message, type = "info") =>
    Toastify({ text: message, className: type }).showToast();

const updateButtonState = (button, disabled, text) => {
    button.disabled = disabled;
    $("#Buy").text(text);
};

const getGasParams = async (web3, from, to, data, multiple = 1.5) => {
    try {
        const gasPrice = await web3.eth.getGasPrice();
        const gas = await web3.eth.estimateGas({ from, to, data });
        return {
            gasPrice: parseInt(gasPrice * multiple),
            gas: parseInt(gas * multiple),
        };
    } catch (error) {
        throw new Error(`Gas estimation failed: ${error.message}`);
    }
};

const checkAllowance = async (web3, feeContract, wallet, contract, rwaCount) => {
    const allowance = await feeContract.methods.allowance(wallet.address, contract).call();
    wallet.allowance = allowance;
    const isApproved = BigInt(allowance) >= BigInt(rwaCount);
    wallet.approve = isApproved;
    return isApproved;
};

const updateButtonTextBasedOnAllowance = async (web3, feeContract, wallet, contract, rwaCount, button) => {
    const isApproved = await checkAllowance(web3, feeContract, wallet, contract, rwaCount);
    updateButtonState(button, false, isApproved ? "Buy" : "Approve");
};

const approve = async (web3, feeContract, wallet, contract, pricePerItem, rwaCount) => {
    const mintBtn = document.getElementById("Buy");
    updateButtonState(mintBtn, true, "Loading");

    console.log("开始授权流程...", { wallet: wallet.address, token: fee_token[network].address, contract });

    try {
        const totalFee = BigInt(rwaCount) * BigInt(pricePerItem);
        console.log("授权金额 (totalFee):", totalFee.toString());

        const balance = await feeContract.methods.balanceOf(wallet.address).call();
        console.log("账户余额:", balance);
        if (BigInt(balance) < totalFee) {
            const decimals = fee_token[network].decimals;
            const required = Number(totalFee) / (10 ** decimals);
            const available = Number(balance) / (10 ** decimals);
            throw new Error(`Insufficient balance: required ${required} USDT, available ${available} USDT`);
        }

        const allowance = await feeContract.methods.allowance(wallet.address, contract).call();
        console.log("当前授权金额:", allowance);

        if (BigInt(allowance) > 0) {
            console.log("正在重置授权为 0...");
            const resetData = feeContract.methods.approve(contract, 0).encodeABI();
            const { gasPrice, gas } = await getGasParams(web3, wallet.address, fee_token[network].address, resetData, 3);
            await feeContract.methods.approve(contract, 0).send({ from: wallet.address, gasPrice, gas });
            console.log("授权已重置为 0");
        }

        const data = feeContract.methods.approve(contract, totalFee).encodeABI();
        const { gasPrice, gas } = await getGasParams(web3, wallet.address, fee_token[network].address, data);
        const result = await feeContract.methods.approve(contract, totalFee).send({ from: wallet.address, gasPrice, gas });

        console.log("授权交易结果:", result);
        console.log("授权金额:", totalFee);

        wallet.approve = true;
        showToast("Approval successful");
        updateButtonState(mintBtn, false, "Buy");
        return true;
    } catch (error) {
        console.error("Approval error:", error);
        showToast(`Approval failed: ${error.message}`, "error");
        updateButtonState(mintBtn, false, "Buy");
        return false;
    }
};

let isProcessing = false;

const handleBuy = async (web3, wallet, provider) => {
    const mintBtn = document.getElementById("Buy");
    const feeContract = new web3.eth.Contract(erc20Abi, fee_token[network].address);

    if (isProcessing) {
        showToast("Transaction is already in progress", "info");
        return;
    }

    isProcessing = true;
    updateButtonState(mintBtn, true, "Loading");

    try {
        const buyContract = new web3.eth.Contract(abi, contract);
        const RWAContract = new web3.eth.Contract(RWAABI, RWA);

        // 检查库存
        const RWABalanceOfSize = await RWAContract.methods.balanceOf(contract).call();

        // 检查是否为chief地址
        const isChiefAddr = await buyContract.methods.theChiefaddr(wallet.address).call();
        if (isChiefAddr) {
            throw new Error("Address is a chief address, please use a different one");
        }

        // 检查推荐人
        const ref = getQueryString("ref");
        if (!isNotEmptyStr(ref)) {
            throw new Error("Affiliate cannot be null");
        }

        const addressRef = await queryAddressQuota(ref);
        if (!addressRef?.data) {
            throw new Error("Invalid affiliate address");
        }
        const finalRef = addressRef.data.ref;

        const franchiseBuyAward = await queryFranchiseBuyAward(finalRef);
        if (!franchiseBuyAward?.data) {
            throw new Error("Invalid affiliate address");
        }

        const rwaIds = franchiseBuyAward.data.buyRWAId
            .trim()
            .split(',')
            .map(id => Number(id));
        if (rwaIds.length === 0) {
            throw new Error("No valid RWA IDs found");
        }
        console.log('rwaIds:', rwaIds);

        if (rwaIds.length > Number(RWABalanceOfSize)) {
            throw new Error("Purchase quantity exceeds maximum inventory");
        }

        const RWAArrays = await RWAContract.methods.tokensOfOwner(contract).call();
        console.log('RWAArrays:', RWAArrays);

        // 验证 rwaIds 中的每个 token ID 是否在 RWAArrays 中
        const missingIds = rwaIds.filter(id => !RWAArrays.includes(String(id)));
        if (missingIds.length > 0) {
            throw new Error(`Contract does not own the following RWA token IDs: ${missingIds.join(', ')}`);
        }

        

        // 检查并处理授权
        const pricePerItem = 320 * (10 ** fee_token[network].decimals);
        if (!(await checkAllowance(web3, feeContract, wallet, contract, pricePerItem * rwaIds.length))) {
            const approved = await approve(web3, feeContract, wallet, contract, pricePerItem, rwaIds.length);
            if (!approved) {
                throw new Error("Approval failed");
            }
            updateButtonState(mintBtn, true, "Loading");
        }

        // 检查钱包连接
        if (wallet.address === walletPlaceholderText) {
            connectWallet(provider);
            updateButtonState(mintBtn, false, "Approve");
            return;
        }

        // 执行购买
        const data = buyContract.methods.buyRWA(rwaIds.length, finalRef, rwaIds).encodeABI();
        const { gasPrice, gas } = await getGasParams(web3, wallet.address, contract, data);
        const estimatedGas = await buyContract.methods.buyRWA(rwaIds.length, finalRef, rwaIds)
            .estimateGas({ from: wallet.address });

        await buyContract.methods.buyRWA(rwaIds.length, finalRef, rwaIds).send({
            from: wallet.address,
            gasPrice: wallet.gasPrice && gasPrice < wallet.gasPrice ? wallet.gasPrice : gasPrice,
            gas: Math.max(gas, estimatedGas),
        });

        wallet.gasPrice = gasPrice;
        showToast("Buy successful", "success");
        await updateButtonTextBasedOnAllowance(web3, feeContract, wallet, contract, pricePerItem * rwaIds.length, mintBtn);

    } catch (error) {
        console.error("Buy error:", error);
        showToast(error.message, "error");
        updateButtonState(mintBtn, false, "Buy"); // 直接将按钮设为 "Buy"
    } finally {
        isProcessing = false;
    }
};

const getFirstElements = (arr, count) =>
    Array.isArray(arr) && typeof count === "number" && count > 0
        ? arr.slice(0, Math.min(count, arr.length))
        : [];

$(() => {
    if (isConnect) connectWallet(provider);
    $("#connect-wallet").click(() => connectWallet(provider));
    $("#Buy").click(() => handleBuy(web3, wallet, provider));
});


    function refIsAffiliateAddressList(ref){

        let isMatch = false;

        for (let i = 0; i < upperCaseAffiliateListAddress.length; i++) {

        if (shortenedEthAddress.startsWith(upperCaseAffiliateListAddress[i])) {
                isMatch = true;
                break;
            }
        }

        return isMatch;
    }

    


    function refAddressAffiliateList(address) {

        var index = upperCaseAffiliateListAddress.indexOf(address);

        return index;

    }


    async function addresIsAffiliateList(value){

        var data = await queryAddressQuota(value);

        if(data === undefined){
            
            return false;
        }

        if(data.code === 200){
            return true;
        }

        return false;
    }

 

    function getQueryString(name) {
        const url_string = document.location.toString();
        const url = new URL(url_string);
        console.log(url);
        return url.searchParams.get(name);
    }


    function isNotEmptyStr(s) {
        if (typeof s == 'string' && s.length > 0) {
            return true
        }
        return false
    }

    async function queryAddressQuota(ref) {
        try {
            let response = await fetch('https://i-t-p.io/third/query/nftOperator', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'address': ref})
            });
            let data = await response.json();
            console.log(data)
            if(data.code == 200){
                return data;
            }
           
        } catch (error) {
            console.error('Error:', error);
            return null;
        }
    }


	async function queryFranchiseBuyAward(ref) {
        try {
            let response = await fetch('https://i-t-p.io/third/query/franchiseBuyAward', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'address': ref})
            });
            let data = await response.json();
            console.log('franchiseBuyAward: ', data)
            if(data.code == 200){
                return data;
            }
           
        } catch (error) {
            console.error('Error:', error);
            return null;
        }
    }


    
</script>

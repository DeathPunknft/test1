<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ‰¹é‡å†™å…¥ç‰¹è®¸ç»è¥å•†åœ°å€ - åˆçº¦äº¤äº’å·¥å…·</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Web3.js v1.x -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <!-- å¼•å…¥ Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#7C3AED',
                        accent: '#10B981',
                        dark: '#121212',
                        'dark-secondary': '#1E1E1E',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .input-large {
                @apply w-full px-4 py-3 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary/60 transition-all border border-gray-600 bg-dark-secondary text-gray-100;
            }
            .textarea-large {
                @apply w-full px-4 py-3 rounded-lg text-base focus:outline-none focus:ring-2 focus:ring-primary/60 transition-all border border-gray-600 bg-dark-secondary text-gray-100 min-h-[180px] resize-y;
            }
            .btn-connect {
                @apply bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 text-lg shadow-lg shadow-primary/20;
            }
            .btn-submit {
                @apply bg-accent hover:bg-accent/90 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 text-lg shadow-lg shadow-accent/20;
            }
            .status-success {
                @apply text-accent bg-accent/10 p-3 rounded-lg border border-accent/30 mt-4;
            }
            .status-error {
                @apply text-red-500 bg-red-500/10 p-3 rounded-lg border border-red-500/30 mt-4;
            }
            .status-loading {
                @apply text-primary bg-primary/10 p-3 rounded-lg border border-primary/30 mt-4;
            }
            .address-tag {
                @apply inline-block bg-gray-700 text-gray-200 px-2 py-1 rounded text-sm mr-2 mb-2;
            }
        }
    </style>
</head>

<body class="bg-dark font-sans text-gray-200 min-h-screen p-4 md:p-8">
    <div class="max-w-2xl mx-auto bg-dark-secondary rounded-xl shadow-2xl p-6 md:p-8">
        <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
        <div class="bg-primary rounded-t-xl p-6 text-center mb-8">
            <h1 class="text-2xl md:text-2xl font-bold flex items-center justify-center">
                <i class="fa fa-users mr-3"></i>æ‰¹é‡æäº¤ç‰¹è®¸ç»è¥å•†åœ°å€
            </h1>
            <p class="text-gray-300 mt-2">ä»…æ‹¥æœ‰ Chief æƒé™çš„åœ°å€å¯æ‰§è¡Œ - æ‰¹é‡è®¾ç½® theChiefaddr æˆæƒ</p>
        </div>

        <!-- é’±åŒ…è¿æ¥åŒº -->
        <div class="text-center mb-8">
            <button id="connectWalletBtn" class="btn-connect">
                <i class="fa fa-wallet mr-2"></i>è¿æ¥é’±åŒ…
            </button>
            <div id="walletInfo" class="mt-4 hidden">
                <p class="text-gray-400">å½“å‰è¿æ¥åœ°å€ï¼š<span id="walletAddr" class="font-mono truncate inline-block w-40"></span></p>
                <p class="text-gray-400">å½“å‰ç½‘ç»œï¼š<span id="networkName">æœªçŸ¥ç½‘ç»œ</span>ï¼ˆé“¾IDï¼š<span id="chainId">--</span>ï¼‰</p>
                <p class="text-gray-400 mt-2">æ˜¯å¦æ‹¥æœ‰æˆæƒæƒé™ï¼š<span id="hasPerm" class="text-yellow-400">æŸ¥è¯¢ä¸­...</span></p>
            </div>
        </div>

        <!-- æ ¸å¿ƒé…ç½®åŒº -->
        <div class="space-y-6 mb-8">
            <!-- ä¸»åˆçº¦åœ°å€ -->
            <div>
                <label class="block text-gray-300 font-bold mb-2 flex items-center">
                    <i class="fa fa-cube mr-2 text-primary"></i>ä¸»åˆçº¦åœ°å€
                </label>
                <input 
                    type="text" 
                    id="mainContractAddress" 
                    class="input-large" 
                    placeholder="è¾“å…¥åŒ…å« setBacthTheChiefaddr å‡½æ•°çš„åˆçº¦åœ°å€"
                    value="0xae22c5a498347E20EC61f1535C6d80D73bCD3262"  <!-- æ›¿æ¢ä¸ºä½ çš„å®é™…ä¸»åˆçº¦åœ°å€ -->
                >
                <p class="text-gray-400 text-sm mt-2">æç¤ºï¼šéœ€è¾“å…¥éƒ¨ç½²äº† setBacthTheChiefaddr å‡½æ•°çš„åˆçº¦åœ°å€</p>
            </div>

            <!-- æ‰¹é‡åœ°å€è¾“å…¥åŒº -->
            <div>
                <label class="block text-gray-300 font-bold mb-2 flex items-center">
                    <i class="fa fa-address-book mr-2 text-primary"></i>æ‰¹é‡ Chief åœ°å€ï¼ˆæ”¯æŒæ¢è¡Œ/é€—å·åˆ†éš”ï¼‰
                </label>
                <textarea 
                    id="batchAddresses" 
                    class="textarea-large" 
                    placeholder="ç¤ºä¾‹ï¼š
0x1234567890abcdef1234567890abcdef12345678
0x876543210fedcba09876543210fedcba09876543
æˆ–ç”¨é€—å·åˆ†éš”ï¼š0x123...,0x876..."></textarea>
                <div class="mt-3">
                    <button id="parseBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-3 py-1 rounded text-sm">
                        <i class="fa fa-magic mr-1"></i>è§£æåœ°å€å¹¶éªŒè¯
                    </button>
                    <p class="text-gray-400 text-sm mt-2">å·²è¯†åˆ«æœ‰æ•ˆåœ°å€ï¼š<span id="validCount">0</span> ä¸ª | æ— æ•ˆåœ°å€ï¼š<span id="invalidCount">0</span> ä¸ª</p>
                </div>
                <div id="addressList" class="mt-3 flex flex-wrap hidden">
                    <!-- è§£æåçš„æœ‰æ•ˆåœ°å€æ ‡ç­¾ä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ -->
                </div>
            </div>
        </div>

        <!-- æ“ä½œæŒ‰é’®åŒº -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
            <button id="submitBtn" class="btn-submit flex-1" disabled>
                <i class="fa fa-check-circle mr-2"></i>æäº¤æ‰¹é‡æˆæƒ
            </button>
            <button id="queryBtn" class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 text-lg flex-1">
                <i class="fa fa-search mr-2"></i>æŸ¥è¯¢åœ°å€æˆæƒçŠ¶æ€
            </button>
        </div>

        <!-- çŠ¶æ€æç¤ºåŒº -->
        <div id="statusContainer" class="mt-6 hidden">
            <div id="statusContent" class="status-loading">
                <i class="fa fa-spinner fa-spin mr-2"></i>å¤„ç†ä¸­...
            </div>
        </div>
    </div>

    <script>
        // ä¸»åˆçº¦ ABIï¼ˆåŒ…å« setBacthTheChiefaddrã€theChiefaddrã€theChiefaddrPerm æ–¹æ³•ï¼‰
        const MAIN_CONTRACT_ABI = [
            {
                "inputs": [{ "internalType": "address[]", "name": "_theChiefaddrs", "type": "address[]" }],
                "name": "setBacthTheChiefaddr",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "name": "theChiefaddr",
                "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [{ "internalType": "address", "name": "", "type": "address" }],
                "name": "theChiefaddrPerm",
                "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // å…¨å±€å˜é‡
        let web3 = "https://rpc.ttchain.info";
        let currentAccount = null;
        let mainContract = "0xae22c5a498347E20EC61f1535C6d80D73bCD3262";
        let validAddresses = []; // å­˜å‚¨è§£æåçš„æœ‰æ•ˆåœ°å€

        // DOM å…ƒç´ 
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddr = document.getElementById('walletAddr');
        const networkName = document.getElementById('networkName');
        const chainId = document.getElementById('chainId');
        const hasPerm = document.getElementById('hasPerm');
        const mainContractAddress = document.getElementById('mainContractAddress');
        const batchAddresses = document.getElementById('batchAddresses');
        const parseBtn = document.getElementById('parseBtn');
        const addressList = document.getElementById('addressList');
        const validCount = document.getElementById('validCount');
        const invalidCount = document.getElementById('invalidCount');
        const submitBtn = document.getElementById('submitBtn');
        const queryBtn = document.getElementById('queryBtn');
        const statusContainer = document.getElementById('statusContainer');
        const statusContent = document.getElementById('statusContent');

        // åˆå§‹åŒ–
        window.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥é’±åŒ…
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                window.ethereum.on('chainChanged', handleChainChanged);
                window.ethereum.on('accountsChanged', handleAccountsChanged);
            } else {
                showStatus('æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·å®‰è£… MetaMask ç­‰ EVM å…¼å®¹é’±åŒ…', 'error');
            }

            // ç»‘å®šäº‹ä»¶
            connectWalletBtn.addEventListener('click', connectWallet);
            parseBtn.addEventListener('click', parseAndValidateAddresses);
            submitBtn.addEventListener('click', submitBatchAuthorize);
            queryBtn.addEventListener('click', queryAuthorizeStatus);
            mainContractAddress.addEventListener('input', initMainContract);
        });

        // å¤„ç†ç½‘ç»œå˜åŒ–
        function handleChainChanged(chainIdHex) {
            const chainIdNum = web3.utils.hexToNumber(chainIdHex);
            chainId.textContent = chainIdNum;
            networkName.textContent = getNetworkName(chainIdNum);
            initMainContract();
        }

        // å¤„ç†è´¦æˆ·å˜åŒ–
        function handleAccountsChanged(accounts) {
            if (accounts.length > 0) {
                currentAccount = accounts[0];
                walletAddr.textContent = currentAccount;
                walletInfo.classList.remove('hidden');
                initMainContract();
            } else {
                currentAccount = null;
                walletInfo.classList.add('hidden');
                submitBtn.disabled = true;
                queryBtn.disabled = true;
            }
        }

        // æ ¹æ®é“¾IDè·å–ç½‘ç»œåç§°
        function getNetworkName(chainId) {
            const networks = {
                1: 'ä»¥å¤ªåŠä¸»ç½‘',
                5: 'Goerli æµ‹è¯•ç½‘',
                1679: 'TT é“¾',
                97: 'BSC æµ‹è¯•ç½‘',
                56: 'BSC ä¸»ç½‘'
            };
            return networks[chainId] || `æœªçŸ¥ç½‘ç»œï¼ˆ${chainId}ï¼‰`;
        }

        // åˆå§‹åŒ–ä¸»åˆçº¦
        async function initMainContract() {
            try {
                const mainAddr = mainContractAddress.value.trim();
                if (!currentAccount || !web3.utils.isAddress(mainAddr)) {
                    submitBtn.disabled = true;
                    queryBtn.disabled = true;
                    hasPerm.textContent = 'æœªå°±ç»ª';
                    return;
                }

                // åˆå§‹åŒ–åˆçº¦å®ä¾‹
                mainContract = new web3.eth.Contract(MAIN_CONTRACT_ABI, mainAddr);
                updateBtnStatus();

                // æ£€æŸ¥å½“å‰è¿æ¥åœ°å€æ˜¯å¦æœ‰æˆæƒæƒé™ï¼ˆtheChiefaddrPermï¼‰
                const perm = await mainContract.methods.theChiefaddrPerm(currentAccount).call();
                hasPerm.textContent = perm ? 'âœ… å·²æ‹¥æœ‰' : 'âŒ æ— æƒé™';
                hasPerm.className = perm ? 'text-green-500' : 'text-red-500';

                showStatus('åˆçº¦åˆå§‹åŒ–æˆåŠŸ', 'success');
            } catch (error) {
                showStatus(`åˆçº¦åˆå§‹åŒ–å¤±è´¥ï¼š${error.message}`, 'error');
                submitBtn.disabled = true;
                queryBtn.disabled = true;
                hasPerm.textContent = 'æŸ¥è¯¢å¤±è´¥';
                console.error('åˆå§‹åŒ–åˆçº¦é”™è¯¯:', error);
            }
        }

        // è§£æå¹¶éªŒè¯è¾“å…¥çš„åœ°å€
        function parseAndValidateAddresses() {
            let input = batchAddresses.value.trim();
            if (!input) {
                showStatus('è¯·è¾“å…¥è¦æˆæƒçš„åœ°å€', 'error');
                return;
            }

            // æ”¯æŒæ¢è¡Œã€é€—å·ã€ç©ºæ ¼åˆ†éš”åœ°å€
            const addressStrs = input
                .replace(/\n/g, ',') // æ¢è¡Œè½¬é€—å·
                .replace(/\s+/g, '') // å»é™¤ç©ºæ ¼
                .split(',') // æŒ‰é€—å·åˆ†å‰²
                .filter(str => str !== ''); // è¿‡æ»¤ç©ºå­—ç¬¦ä¸²

            // éªŒè¯åœ°å€æœ‰æ•ˆæ€§
            validAddresses = [];
            let invalidAddrs = [];
            addressStrs.forEach(str => {
                if (web3.utils.isAddress(str)) {
                    validAddresses.push(str.toLowerCase()); // è½¬ä¸ºå°å†™ç»Ÿä¸€æ ¼å¼
                } else {
                    invalidAddrs.push(str);
                }
            });

            // æ›´æ–°ç»Ÿè®¡å’ŒUI
            validCount.textContent = validAddresses.length;
            invalidCount.textContent = invalidAddrs.length;

            // æ˜¾ç¤ºæœ‰æ•ˆåœ°å€æ ‡ç­¾
            addressList.innerHTML = '';
            if (validAddresses.length > 0) {
                addressList.classList.remove('hidden');
                validAddresses.forEach(addr => {
                    const tag = document.createElement('span');
                    tag.className = 'address-tag';
                    tag.innerHTML = `${addr.slice(0, 6)}...${addr.slice(-4)} <i class="fa fa-check text-green-500 ml-1"></i>`;
                    addressList.appendChild(tag);
                });
            } else {
                addressList.classList.add('hidden');
            }

            // æç¤ºæ— æ•ˆåœ°å€
            if (invalidAddrs.length > 0) {
                showStatus(`å‘ç° ${invalidAddrs.length} ä¸ªæ— æ•ˆåœ°å€ï¼š${invalidAddrs.join(', ')}`, 'error');
            } else {
                showStatus(`æˆåŠŸè§£æ ${validAddresses.length} ä¸ªæœ‰æ•ˆåœ°å€`, 'success');
            }

            updateBtnStatus();
        }

        // æ›´æ–°æŒ‰é’®çŠ¶æ€
        function updateBtnStatus() {
            const mainAddrValid = web3.utils.isAddress(mainContractAddress.value.trim());
            const hasValidAddrs = validAddresses.length > 0;
            const hasPermission = hasPerm.textContent === 'âœ… å·²æ‹¥æœ‰';
            
            submitBtn.disabled = !mainAddrValid || !hasValidAddrs || !currentAccount || !mainContract || !hasPermission;
            queryBtn.disabled = !mainAddrValid || !hasValidAddrs || !currentAccount || !mainContract;
        }

        // æäº¤æ‰¹é‡æˆæƒï¼ˆè°ƒç”¨ setBacthTheChiefaddrï¼‰
        async function submitBatchAuthorize() {
            if (!mainContract || !currentAccount || validAddresses.length === 0) {
                showStatus('è¯·å…ˆè§£ææœ‰æ•ˆåœ°å€å¹¶ç¡®ä¿é’±åŒ…å·²è¿æ¥', 'error');
                return;
            }

            try {
                showStatus(`æ­£åœ¨æ‰¹é‡æˆæƒ ${validAddresses.length} ä¸ªåœ°å€...`, 'loading');
                submitBtn.disabled = true;

                // è°ƒç”¨æ‰¹é‡æˆæƒå‡½æ•°
                const txObj = await mainContract.methods.setBacthTheChiefaddr(validAddresses)
                    .send({
                        from: currentAccount,
                        gas: 300000 + (validAddresses.length * 30000) // åŠ¨æ€è®¡ç®—Gasï¼ˆæ¯ä¸ªåœ°å€çº¦3ä¸‡Gasï¼‰
                    });

                // æ˜¾ç¤ºæˆåŠŸç»“æœ
                const txHash = txObj.transactionHash;
                const explorerUrl = `https://åŒºå—æµè§ˆå™¨åœ°å€/tx/${txHash}`; // æ›¿æ¢ä¸ºä½ çš„åŒºå—æµè§ˆå™¨åœ°å€
                showStatus(`âœ… æ‰¹é‡æˆæƒæˆåŠŸï¼å…±æˆæƒ ${validAddresses.length} ä¸ªåœ°å€<br>äº¤æ˜“å“ˆå¸Œï¼š<a href="${explorerUrl}" target="_blank" class="text-primary underline">${txHash.slice(0, 10)}...${txHash.slice(-6)}</a>`, 'success');

                // æ¸…ç©ºè¾“å…¥æ¡†å’Œè§£æç»“æœ
                batchAddresses.value = '';
                addressList.innerHTML = '';
                validAddresses = [];
                validCount.textContent = '0';
                invalidCount.textContent = '0';
            } catch (error) {
                const errorMsg = error.message.includes('reverted') 
                    ? 'æˆæƒå¤±è´¥ï¼ˆå¯èƒ½æ— æƒé™æˆ–åˆçº¦æ‰§è¡Œé”™è¯¯ï¼‰' 
                    : error.message;
                showStatus(`âŒ æ‰¹é‡æˆæƒå¤±è´¥ï¼š${errorMsg}`, 'error');
                console.error('æˆæƒé”™è¯¯:', error);
                submitBtn.disabled = false;
            }
        }

        // æŸ¥è¯¢å·²è§£æåœ°å€çš„æˆæƒçŠ¶æ€
        async function queryAuthorizeStatus() {
            if (!mainContract || !currentAccount || validAddresses.length === 0) {
                showStatus('è¯·å…ˆè§£ææœ‰æ•ˆåœ°å€', 'error');
                return;
            }

            try {
                showStatus(`æ­£åœ¨æŸ¥è¯¢ ${validAddresses.length} ä¸ªåœ°å€çš„æˆæƒçŠ¶æ€...`, 'loading');

                // æ‰¹é‡æŸ¥è¯¢æ¯ä¸ªåœ°å€çš„æˆæƒçŠ¶æ€
                const statusList = [];
                for (const addr of validAddresses) {
                    const isAuthorized = await mainContract.methods.theChiefaddr(addr).call();
                    statusList.push({ addr, isAuthorized });
                }

                // æ˜¾ç¤ºæŸ¥è¯¢ç»“æœ
                let statusHtml = 'ğŸ“‹ æŸ¥è¯¢ç»“æœï¼š<br>';
                statusList.forEach(item => {
                    const statusText = item.isAuthorized ? 'âœ… å·²æˆæƒ' : 'âŒ æœªæˆæƒ';
                    const statusClass = item.isAuthorized ? 'text-green-500' : 'text-red-500';
                    statusHtml += `- ${item.addr.slice(0, 10)}...${item.addr.slice(-4)}: <span class="${statusClass}">${statusText}</span><br>`;
                });

                showStatus(statusHtml, 'success');
            } catch (error) {
                showStatus(`âŒ æŸ¥è¯¢å¤±è´¥ï¼š${error.message}`, 'error');
                console.error('æŸ¥è¯¢é”™è¯¯:', error);
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            if (!window.ethereum) {
                showStatus('æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·å®‰è£… MetaMask', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨è¿æ¥é’±åŒ…...', 'loading');
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];
                const chainIdHex = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdNum = web3.utils.hexToNumber(chainIdHex);

                // æ›´æ–°UI
                walletAddr.textContent = currentAccount;
                chainId.textContent = chainIdNum;
                networkName.textContent = getNetworkName(chainIdNum);
                walletInfo.classList.remove('hidden');
                connectWalletBtn.textContent = 'å·²è¿æ¥';
                connectWalletBtn.disabled = true;

                // åˆå§‹åŒ–åˆçº¦å¹¶æ£€æŸ¥æƒé™
                await initMainContract();

                showStatus('é’±åŒ…è¿æ¥æˆåŠŸ', 'success');
            } catch (error) {
                showStatus(`é’±åŒ…è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
                console.error('è¿æ¥é’±åŒ…é”™è¯¯:', error);
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€æç¤º
        function showStatus(message, type) {
            statusContainer.classList.remove('hidden');
            statusContent.innerHTML = message; // æ”¯æŒHTMLæ ¼å¼

            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusContent.classList.remove('status-success', 'status-error', 'status-loading');
            
            // æ·»åŠ å¯¹åº”çŠ¶æ€ç±»
            if (type === 'success') {
                statusContent.classList.add('status-success');
            } else if (type === 'error') {
                statusContent.classList.add('status-error');
            } else {
                statusContent.classList.add('status-loading');
            }

            // 8ç§’åè‡ªåŠ¨éšè—æˆåŠŸ/é”™è¯¯æç¤º
            if (type !== 'loading') {
                setTimeout(() => {
                    statusContainer.classList.add('hidden');
                }, 12000);
            }
        }
    </script>
</body>
</html>
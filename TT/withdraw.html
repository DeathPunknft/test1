<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RWAåˆçº¦ææ¬¾å·¥å…· - ä»…æˆæƒåœ°å€å¯ç”¨</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Web3.js v1.x -->
    <script src="https://cdn.jsdelivr.net/npm/web3@1.10.0/dist/web3.min.js"></script>
    <!-- å¼•å…¥ Font Awesome -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#2563EB',
                        accent: '#10B981',
                        warning: '#F59E0B',
                        dark: '#111827',
                        'dark-secondary': '#1F2937',
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .card {
                @apply bg-dark-secondary rounded-xl shadow-lg p-6 border border-gray-700;
            }
            .btn-primary {
                @apply bg-primary hover:bg-primary/90 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-md shadow-primary/20 flex items-center justify-center gap-2;
            }
            .btn-success {
                @apply bg-accent hover:bg-accent/90 text-white font-bold py-3 px-6 rounded-lg transition-all duration-300 shadow-md shadow-accent/20 flex items-center justify-center gap-2;
            }
            .btn-disabled {
                @apply bg-gray-600 text-gray-400 cursor-not-allowed py-3 px-6 rounded-lg shadow-md flex items-center justify-center gap-2;
            }
            .status-success {
                @apply text-accent bg-accent/10 p-4 rounded-lg border border-accent/30 mt-4;
            }
            .status-error {
                @apply text-red-500 bg-red-500/10 p-4 rounded-lg border border-red-500/30 mt-4;
            }
            .status-loading {
                @apply text-primary bg-primary/10 p-4 rounded-lg border border-primary/30 mt-4;
            }
            .balance-card {
                @apply bg-gradient-to-r from-primary/10 to-accent/10 rounded-xl p-6 border border-primary/20 flex flex-col md:flex-row justify-between items-center gap-4;
            }
        }
    </style>
</head>

<body class="bg-dark font-sans text-gray-200 min-h-screen p-4 md:p-8">
    <div class="max-w-xl mx-auto">
        <!-- é¡¶éƒ¨æ ‡é¢˜åŒº -->
        <div class="text-center mb-8">
            <h1 class="text-2xl md:text-3xl font-bold text-white flex items-center justify-center gap-3">
                <i class="fa fa-money text-accent"></i>RWAåˆçº¦ææ¬¾å·¥å…·
            </h1>
            <p class="text-gray-400 mt-2">ä»…æˆæƒææ¬¾åœ°å€ï¼ˆonlyWithdrawAuthï¼‰å¯æ‰§è¡Œææ¬¾æ“ä½œ</p>
        </div>

        <!-- é’±åŒ…è¿æ¥åŒº -->
        <div class="card mb-8">
            <div class="text-center">
                <button id="connectWalletBtn" class="btn-primary w-full">
                    <i class="fa fa-wallet"></i> è¿æ¥é’±åŒ…
                </button>
                <div id="walletInfo" class="mt-4 hidden">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-2">
                        <p class="text-gray-300">å½“å‰åœ°å€ï¼š<span id="walletAddr" class="font-mono text-white truncate inline-block w-48"></span></p>
                        <p class="text-gray-300">ç½‘ç»œï¼š<span id="networkName" class="text-warning">æœªçŸ¥</span>ï¼ˆé“¾IDï¼š<span id="chainId">--</span>ï¼‰</p>
                    </div>
                    <div class="mt-3 p-3 bg-gray-800/50 rounded-lg">
                        <p class="text-gray-300">ææ¬¾æƒé™ï¼š<span id="withdrawAuthStatus" class="text-yellow-400">æŸ¥è¯¢ä¸­...</span></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- æ ¸å¿ƒææ¬¾åŒº -->
        <div class="card mb-8">
            <h2 class="text-xl font-bold text-white mb-6 flex items-center gap-2">
                <i class="fa fa-balance-scale text-primary"></i> åˆçº¦ä½™é¢ä¸ææ¬¾
            </h2>

            <!-- ä½™é¢æ˜¾ç¤ºå¡ç‰‡ -->
            <div class="balance-card mb-6">
                <div>
                    <p class="text-gray-400 text-sm">åˆçº¦å¯ç”¨ä½™é¢ï¼ˆUSDTï¼‰</p>
                    <p id="contractBalance" class="text-2xl md:text-3xl font-bold text-white">--</p>
                    <p class="text-gray-500 text-xs mt-1">ï¼ˆæœ€å°å•ä½ï¼š1 USDT = 1e6ï¼‰</p>
                </div>
                <button id="refreshBalanceBtn" class="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded-lg flex items-center gap-2">
                    <i class="fa fa-refresh"></i> åˆ·æ–°ä½™é¢
                </button>
            </div>

            <!-- ä¸»åˆçº¦åœ°å€é…ç½® -->
            <div class="mb-6">
                <label class="block text-gray-300 font-medium mb-2">ä¸»åˆçº¦åœ°å€</label>
                <input 
                    type="text" 
                    id="mainContractAddress" 
                    class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary/60"
                    placeholder="è¾“å…¥éƒ¨ç½² withdraw å‡½æ•°çš„åˆçº¦åœ°å€"
                    value="0xae22c5a498347E20EC61f1535C6d80D73bCD3262"  <!-- æ›¿æ¢ä¸ºå®é™…ä¸»åˆçº¦åœ°å€ -->
                >
                <p class="text-gray-500 text-xs mt-1">æç¤ºï¼šéœ€è¾“å…¥åŒ…å« withdraw å‡½æ•°çš„åˆçº¦åœ°å€</p>
            </div>

            <!-- USDT åˆçº¦åœ°å€é…ç½®ï¼ˆå¯é€‰ï¼Œç”¨äºæ˜¾ç¤ºæ­£ç¡®ç¬¦å·ï¼‰ -->
            <div class="mb-6">
                <label class="block text-gray-300 font-medium mb-2">USDT åˆçº¦åœ°å€</label>
                <input 
                    type="text" 
                    id="usdtContractAddress" 
                    class="w-full px-4 py-2 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-primary/60"
                    placeholder=""
                    value="0x6Ef08B52430c7304Ce789D2004d863279Ce2eB78"  <!-- æ›¿æ¢ä¸ºå®é™… USDT åˆçº¦åœ°å€ -->
                >
                <p class="text-gray-500 text-xs mt-1">æç¤ºï¼šç”¨äºæŸ¥è¯¢ USDT ç¬¦å·å’Œå°æ•°ä½æ•°ï¼ˆé»˜è®¤ 6 ä½ï¼‰</p>
            </div>

            <!-- ææ¬¾æŒ‰é’® -->
            <button id="withdrawBtn" class="btn-disabled w-full" disabled>
                <i class="fa fa-arrow-circle-down"></i> ææ¬¾ï¼ˆéœ€æˆæƒåœ°å€ï¼‰
            </button>
        </div>

        <!-- çŠ¶æ€æç¤ºåŒº -->
        <div id="statusContainer" class="hidden">
            <div id="statusContent" class="status-loading">
                <i class="fa fa-spinner fa-spin mr-2"></i> å¤„ç†ä¸­...
            </div>
        </div>

        <!-- äº¤æ˜“è®°å½•åŒº -->
        <div class="card mt-8">
            <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                <i class="fa fa-history text-primary"></i> æœ€è¿‘ææ¬¾è®°å½•
            </h2>
            <div id="txHistory" class="text-gray-400 text-center py-6">
                æš‚æ— ææ¬¾è®°å½•
            </div>
        </div>
    </div>

    <script>
        // ========== æ ¸å¿ƒé…ç½® ==========
        // ä¸»åˆçº¦ ABIï¼ˆåŒ…å« withdrawã€onlyWithdrawAuthã€payERC20Token ç›¸å…³æ–¹æ³•ï¼‰
        const MAIN_CONTRACT_ABI = [
            // withdraw ææ¬¾å‡½æ•°
            {
                "inputs": [],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            // æ£€æŸ¥æ˜¯å¦æœ‰ææ¬¾æƒé™ï¼ˆonlyWithdrawAuth å¯¹åº”çš„æƒé™åˆ¤æ–­ï¼Œéœ€ä¸åˆçº¦ä¸€è‡´ï¼‰
            {
                "inputs": [], // æ— å‚æ•°ï¼ˆå› ä¸ºæ˜¯å˜é‡çš„ getter æ–¹æ³•ï¼‰
                "name": "withdrawAuthAddr", // æ–¹æ³•åå’Œå˜é‡åä¸€è‡´
                "outputs": [{ "internalType": "address", "name": "", "type": "address" }], // è¿”å› address ç±»å‹
                "stateMutability": "view",
                "type": "function"
            },
            // è·å– payERC20Token åˆçº¦åœ°å€ï¼ˆç”¨äºæŸ¥è¯¢ä½™é¢ï¼‰
            {
                "inputs": [],
                "name": "payERC20Token",
                "outputs": [{ "internalType": "contract ERC20Token", "name": "", "type": "address" }],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // ERC20 ä»£å¸ ABIï¼ˆç”¨äºæŸ¥è¯¢ä½™é¢å’Œç¬¦å·ï¼‰
        const ERC20_ABI = [
            {
                "inputs": [{ "internalType": "address", "name": "account", "type": "address" }],
                "name": "balanceOf",
                "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "symbol",
                "outputs": [{ "internalType": "string", "name": "", "type": "string" }],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "decimals",
                "outputs": [{ "internalType": "uint8", "name": "", "type": "uint8" }],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // å…¨å±€å˜é‡
        let web3 = "https://rpc.ttchain.info";
        let currentAccount = null;
        let mainContract = "0xae22c5a498347E20EC61f1535C6d80D73bCD3262";
        let usdtContract = "0x6Ef08B52430c7304Ce789D2004d863279Ce2eB78";
        let usdtDecimals = 6; // é»˜è®¤ USDT 6 ä½å°æ•°
        let usdtSymbol = "USDT"; // é»˜è®¤ç¬¦å·

        // DOM å…ƒç´ 
        const connectWalletBtn = document.getElementById('connectWalletBtn');
        const walletInfo = document.getElementById('walletInfo');
        const walletAddr = document.getElementById('walletAddr');
        const networkName = document.getElementById('networkName');
        const chainId = document.getElementById('chainId');
        const withdrawAuthStatus = document.getElementById('withdrawAuthStatus');
        const mainContractAddress = document.getElementById('mainContractAddress');
        const usdtContractAddress = document.getElementById('usdtContractAddress');
        const contractBalance = document.getElementById('contractBalance');
        const refreshBalanceBtn = document.getElementById('refreshBalanceBtn');
        const withdrawBtn = document.getElementById('withdrawBtn');
        const statusContainer = document.getElementById('statusContainer');
        const statusContent = document.getElementById('statusContent');
        const txHistory = document.getElementById('txHistory');

        // ========== åˆå§‹åŒ– ==========
        window.addEventListener('DOMContentLoaded', () => {
            // æ£€æŸ¥é’±åŒ…
            if (window.ethereum) {
                web3 = new Web3(window.ethereum);
                // ç›‘å¬ç½‘ç»œå˜åŒ–
                window.ethereum.on('chainChanged', handleChainChanged);
                // ç›‘å¬è´¦æˆ·å˜åŒ–
                window.ethereum.on('accountsChanged', handleAccountsChanged);
            } else {
                showStatus('æœªæ£€æµ‹åˆ° EVM å…¼å®¹é’±åŒ…ï¼ˆå¦‚ MetaMaskï¼‰ï¼Œè¯·å®‰è£…åé‡è¯•', 'error');
            }

            // ç»‘å®šäº‹ä»¶
            connectWalletBtn.addEventListener('click', connectWallet);
            refreshBalanceBtn.addEventListener('click', fetchContractBalance);
            withdrawBtn.addEventListener('click', executeWithdraw);
            mainContractAddress.addEventListener('input', initMainContract);
            usdtContractAddress.addEventListener('input', initUsdtContract);

            // åˆå§‹åŒ–åˆçº¦ï¼ˆè‹¥åœ°å€å·²å¡«å†™ï¼‰
            if (web3.utils.isAddress(mainContractAddress.value.trim())) {
                initMainContract();
            }
            if (web3.utils.isAddress(usdtContractAddress.value.trim())) {
                initUsdtContract();
            }
        });

        // ========== é’±åŒ…ä¸ç½‘ç»œç›¸å…³ ==========
        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            if (!window.ethereum) {
                showStatus('æœªæ£€æµ‹åˆ°é’±åŒ…ï¼Œè¯·å®‰è£… MetaMask', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨è¿æ¥é’±åŒ…...', 'loading');
                // è¯·æ±‚æˆæƒè´¦æˆ·
                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];
                // è·å–å½“å‰ç½‘ç»œ
                const chainIdHex = await window.ethereum.request({ method: 'eth_chainId' });
                const chainIdNum = web3.utils.hexToNumber(chainIdHex);

                // æ›´æ–° UI
                walletAddr.textContent = currentAccount;
                chainId.textContent = chainIdNum;
                networkName.textContent = getNetworkName(chainIdNum);
                walletInfo.classList.remove('hidden');
                connectWalletBtn.textContent = 'å·²è¿æ¥';
                connectWalletBtn.disabled = true;
                connectWalletBtn.className = 'btn-disabled w-full';

                // åˆå§‹åŒ–åˆçº¦
                await initMainContract();
                await initUsdtContract();
                // æŸ¥è¯¢æƒé™å’Œä½™é¢
                await checkWithdrawAuth();
                await fetchContractBalance();

                showStatus('é’±åŒ…è¿æ¥æˆåŠŸ', 'success');
            } catch (error) {
                showStatus(`é’±åŒ…è¿æ¥å¤±è´¥ï¼š${error.message}`, 'error');
                console.error('è¿æ¥é’±åŒ…é”™è¯¯ï¼š', error);
            }
        }

        // å¤„ç†ç½‘ç»œå˜åŒ–
        async function handleChainChanged(chainIdHex) {
            const chainIdNum = web3.utils.hexToNumber(chainIdHex);
            chainId.textContent = chainIdNum;
            networkName.textContent = getNetworkName(chainIdNum);

            // é‡æ–°åˆå§‹åŒ–åˆçº¦
            await initMainContract();
            await initUsdtContract();
            // é‡æ–°æŸ¥è¯¢æƒé™å’Œä½™é¢
            if (currentAccount) {
                await checkWithdrawAuth();
                await fetchContractBalance();
            }
        }

        // å¤„ç†è´¦æˆ·å˜åŒ–
        async function handleAccountsChanged(accounts) {
            if (accounts.length > 0) {
                currentAccount = accounts[0];
                walletAddr.textContent = currentAccount;
                // é‡æ–°æŸ¥è¯¢æƒé™
                await checkWithdrawAuth();
            } else {
                // è´¦æˆ·æ–­å¼€è¿æ¥
                currentAccount = null;
                walletInfo.classList.add('hidden');
                connectWalletBtn.textContent = 'è¿æ¥é’±åŒ…';
                connectWalletBtn.disabled = false;
                connectWalletBtn.className = 'btn-primary w-full';
                withdrawBtn.disabled = true;
                withdrawBtn.className = 'btn-disabled w-full';
                withdrawAuthStatus.textContent = 'æœªè¿æ¥é’±åŒ…';
                contractBalance.textContent = '--';
            }
        }

        // æ ¹æ®é“¾IDè·å–ç½‘ç»œåç§°
        function getNetworkName(chainId) {
            const networks = {
                1: 'ä»¥å¤ªåŠä¸»ç½‘',
                5: 'ä»¥å¤ªåŠ Goerli æµ‹è¯•ç½‘',
                1679: 'TT é“¾',
                97: 'BSC æµ‹è¯•ç½‘',
                56: 'BSC ä¸»ç½‘',
                137: 'Polygon ä¸»ç½‘',
                80001: 'Polygon Mumbai æµ‹è¯•ç½‘'
            };
            return networks[chainId] || `æœªçŸ¥ç½‘ç»œï¼ˆ${chainId}ï¼‰`;
        }

        // ========== åˆçº¦åˆå§‹åŒ– ==========
        // åˆå§‹åŒ–ä¸»åˆçº¦
        async function initMainContract() {
            try {
                const mainAddr = mainContractAddress.value.trim();
                if (!web3.utils.isAddress(mainAddr)) {
                    mainContract = null;
                    withdrawBtn.disabled = true;
                    withdrawBtn.className = 'btn-disabled w-full';
                    return;
                }

                mainContract = new web3.eth.Contract(MAIN_CONTRACT_ABI, mainAddr);
                showStatus('ä¸»åˆçº¦åˆå§‹åŒ–æˆåŠŸ', 'success');
            } catch (error) {
                mainContract = null;
                showStatus(`ä¸»åˆçº¦åˆå§‹åŒ–å¤±è´¥ï¼š${error.message}`, 'error');
                withdrawBtn.disabled = true;
                withdrawBtn.className = 'btn-disabled w-full';
                console.error('åˆå§‹åŒ–ä¸»åˆçº¦é”™è¯¯ï¼š', error);
            }
        }

        // åˆå§‹åŒ– USDT åˆçº¦
        async function initUsdtContract() {
            try {
                const usdtAddr = usdtContractAddress.value.trim();
                if (!web3.utils.isAddress(usdtAddr)) {
                    usdtContract = null;
                    usdtDecimals = 6;
                    usdtSymbol = "USDT";
                    return;
                }

                usdtContract = new web3.eth.Contract(ERC20_ABI, usdtAddr);
                // è·å– USDT å°æ•°ä½æ•°å’Œç¬¦å·ï¼ˆè¦†ç›–é»˜è®¤å€¼ï¼‰
                usdtDecimals = await usdtContract.methods.decimals().call();
                usdtSymbol = await usdtContract.methods.symbol().call();
                showStatus(`USDT åˆçº¦åˆå§‹åŒ–æˆåŠŸï¼ˆç¬¦å·ï¼š${usdtSymbol}ï¼Œå°æ•°ï¼š${usdtDecimals} ä½ï¼‰`, 'success');
            } catch (error) {
                usdtContract = null;
                usdtDecimals = 6;
                usdtSymbol = "USDT";
                showStatus(`USDT åˆçº¦åˆå§‹åŒ–å¤±è´¥ï¼š${error.message}`, 'error');
                console.error('åˆå§‹åŒ– USDT åˆçº¦é”™è¯¯ï¼š', error);
            }
        }

        // ========== æ ¸å¿ƒä¸šåŠ¡é€»è¾‘ ==========
        // æ£€æŸ¥å½“å‰åœ°å€æ˜¯å¦æœ‰ææ¬¾æƒé™
        async function checkWithdrawAuth() {
            if (!mainContract || !currentAccount) {
                withdrawAuthStatus.textContent = 'æœªå°±ç»ª';
                withdrawAuthStatus.className = 'text-yellow-400';
                withdrawBtn.disabled = true;
                withdrawBtn.className = 'btn-disabled w-full';
                return;
            }

            try {
                showStatus('æ­£åœ¨æŸ¥è¯¢ææ¬¾æƒé™...', 'loading');
                // ğŸ‘‡ æ ¸å¿ƒä¿®æ”¹ï¼šæŸ¥è¯¢åˆçº¦ä¸­çš„ withdrawAuthAddr å˜é‡ï¼ˆæ— å‚æ•°ï¼Œå› ä¸ºæ˜¯ public å˜é‡çš„ getter æ–¹æ³•ï¼‰
                const authAddr = await mainContract.methods.withdrawAuthAddr().call();
                // æ¯”è¾ƒå½“å‰è¿æ¥åœ°å€å’Œæˆæƒåœ°å€ï¼ˆè½¬å°å†™é¿å…å¤§å°å†™é—®é¢˜ï¼‰
                const hasAuth = authAddr.toLowerCase() === currentAccount.toLowerCase();

                if (hasAuth) {
                    withdrawAuthStatus.textContent = 'âœ… å·²æˆæƒï¼ˆå¯ææ¬¾ï¼‰';
                    withdrawAuthStatus.className = 'text-green-500';
                    withdrawBtn.disabled = false;
                    withdrawBtn.className = 'btn-success w-full';
                    withdrawBtn.innerHTML = '<i class="fa fa-arrow-circle-down"></i> ä¸€é”®ææ¬¾ï¼ˆå…¨éƒ¨ä½™é¢ï¼‰';
                } else {
                    withdrawAuthStatus.textContent = `âŒ æœªæˆæƒï¼ˆä»… ${authAddr.slice(0, 10)}... å¯ææ¬¾ï¼‰`;
                    withdrawAuthStatus.className = 'text-red-500';
                    withdrawBtn.disabled = true;
                    withdrawBtn.className = 'btn-disabled w-full';
                }
            } catch (error) {
                withdrawAuthStatus.textContent = 'æŸ¥è¯¢å¤±è´¥';
                withdrawAuthStatus.className = 'text-red-500';
                withdrawBtn.disabled = true;
                withdrawBtn.className = 'btn-disabled w-full';
                showStatus(`æƒé™æŸ¥è¯¢å¤±è´¥ï¼š${error.message}`, 'error');
                console.error('æŸ¥è¯¢ææ¬¾æƒé™é”™è¯¯ï¼š', error);
            }
        }

        // æŸ¥è¯¢åˆçº¦ USDT ä½™é¢
        async function fetchContractBalance() {
            if (!mainContract || !usdtContract) {
                contractBalance.textContent = 'åˆçº¦æœªåˆå§‹åŒ–';
                showStatus('è¯·å…ˆå¡«å†™æ­£ç¡®çš„ä¸»åˆçº¦å’Œ USDT åˆçº¦åœ°å€', 'error');
                return;
            }

            try {
                showStatus('æ­£åœ¨æŸ¥è¯¢åˆçº¦ä½™é¢...', 'loading');
                // è·å–ä¸»åˆçº¦åœ°å€ï¼ˆç”¨äºæŸ¥è¯¢ USDT ä½™é¢ï¼‰
                const mainAddr = mainContractAddress.value.trim();
                // æŸ¥è¯¢ USDT ä½™é¢ï¼ˆæœ€å°å•ä½ï¼‰
                const balanceWei = await usdtContract.methods.balanceOf(mainAddr).call();
                // è½¬æ¢ä¸ºå¯è¯»æ ¼å¼ï¼ˆå¦‚ 6 ä½å°æ•°ï¼‰
                const balanceReadable = web3.utils.fromWei(balanceWei, 'ether') * (10 ** (18 - usdtDecimals));
                // ä¿ç•™ 6 ä½å°æ•°æ˜¾ç¤º
                contractBalance.textContent = balanceReadable.toFixed(6) + ' ' + usdtSymbol;

                // è‹¥ä½™é¢ä¸º 0ï¼Œæç¤ºæ— ææ¬¾é‡‘é¢
                if (Number(balanceWei) === 0) {
                    showStatus('åˆçº¦ä½™é¢ä¸º 0ï¼Œæ— éœ€ææ¬¾', 'success');
                } else {
                    showStatus('ä½™é¢æŸ¥è¯¢æˆåŠŸ', 'success');
                }
            } catch (error) {
                contractBalance.textContent = 'æŸ¥è¯¢å¤±è´¥';
                showStatus(`ä½™é¢æŸ¥è¯¢å¤±è´¥ï¼š${error.message}`, 'error');
                console.error('æŸ¥è¯¢åˆçº¦ä½™é¢é”™è¯¯ï¼š', error);
            }
        }

        // æ‰§è¡Œææ¬¾æ“ä½œ
        async function executeWithdraw() {
            if (!mainContract || !currentAccount || !usdtContract) {
                showStatus('è¯·å…ˆè¿æ¥é’±åŒ…å¹¶åˆå§‹åŒ–åˆçº¦', 'error');
                return;
            }

            try {
                // å…ˆæŸ¥è¯¢ä½™é¢ï¼Œç¡®è®¤æœ‰å¯ææ¬¾é‡‘é¢
                const mainAddr = mainContractAddress.value.trim();
                const balanceWei = await usdtContract.methods.balanceOf(mainAddr).call();
                if (Number(balanceWei) === 0) {
                    showStatus('åˆçº¦ä½™é¢ä¸º 0ï¼Œæ— æ³•ææ¬¾', 'error');
                    return;
                }

                showStatus(`æ­£åœ¨ææ¬¾ ${web3.utils.fromWei(balanceWei, 'ether') * (10 ** (18 - usdtDecimals))} ${usdtSymbol}...`, 'loading');
                withdrawBtn.disabled = true;
                withdrawBtn.className = 'btn-disabled w-full';

                // è°ƒç”¨ withdraw å‡½æ•°
                const txObj = await mainContract.methods.withdraw()
                    .send({
                        from: currentAccount,
                        gas: 200000 // è¶³å¤Ÿçš„ Gas ä¸Šé™ï¼ˆå¯æ ¹æ®å®é™…è°ƒæ•´ï¼‰
                    });

                const txHash = txObj.transactionHash;
                const explorerUrl = `https://åŒºå—æµè§ˆå™¨åœ°å€/tx/${txHash}`; // æ›¿æ¢ä¸ºä½ çš„ç½‘ç»œåŒºå—æµè§ˆå™¨
                const balanceReadable = web3.utils.fromWei(balanceWei, 'ether') * (10 ** (18 - usdtDecimals));

                // æ˜¾ç¤ºæˆåŠŸçŠ¶æ€
                showStatus(`âœ… ææ¬¾æˆåŠŸï¼<br>é‡‘é¢ï¼š${balanceReadable.toFixed(6)} ${usdtSymbol}<br>äº¤æ˜“å“ˆå¸Œï¼š<a href="${explorerUrl}" target="_blank" class="text-primary underline">${txHash.slice(0, 10)}...${txHash.slice(-6)}</a>`, 'success');

                // æ›´æ–°äº¤æ˜“è®°å½•
                updateTxHistory(txHash, balanceReadable.toFixed(6) + ' ' + usdtSymbol);

                // åˆ·æ–°ä½™é¢ï¼ˆææ¬¾åä½™é¢åº”ä¸º 0ï¼‰
                setTimeout(fetchContractBalance, 3000);
            } catch (error) {
                withdrawBtn.disabled = false;
                withdrawBtn.className = 'btn-success w-full';
                const errorMsg = error.message.includes('reverted') 
                    ? error.message.includes('No balance to withdraw') 
                        ? 'æ— å¯ç”¨ä½™é¢ææ¬¾' 
                        : 'ææ¬¾å¤±è´¥ï¼ˆå¯èƒ½æ— æƒé™æˆ–åˆçº¦æ‰§è¡Œé”™è¯¯ï¼‰'
                    : error.message;
                showStatus(`âŒ ææ¬¾å¤±è´¥ï¼š${errorMsg}`, 'error');
                console.error('ææ¬¾é”™è¯¯ï¼š', error);
            }
        }

        // ========== è¾…åŠ©åŠŸèƒ½ ==========
        // æ˜¾ç¤ºçŠ¶æ€æç¤º
        function showStatus(message, type) {
            statusContainer.classList.remove('hidden');
            statusContent.innerHTML = message;

            // ç§»é™¤æ‰€æœ‰çŠ¶æ€ç±»
            statusContent.classList.remove('status-success', 'status-error', 'status-loading');
            // æ·»åŠ å¯¹åº”çŠ¶æ€ç±»
            if (type === 'success') {
                statusContent.classList.add('status-success');
            } else if (type === 'error') {
                statusContent.classList.add('status-error');
            } else {
                statusContent.classList.add('status-loading');
            }

            // æˆåŠŸ/é”™è¯¯æç¤º 8 ç§’åè‡ªåŠ¨éšè—
            if (type !== 'loading') {
                setTimeout(() => {
                    statusContainer.classList.add('hidden');
                }, 8000);
            }
        }

        // æ›´æ–°ææ¬¾è®°å½•
        function updateTxHistory(txHash, amount) {
            const explorerUrl = `https://åŒºå—æµè§ˆå™¨åœ°å€/tx/${txHash}`; // æ›¿æ¢ä¸ºä½ çš„ç½‘ç»œåŒºå—æµè§ˆå™¨
            const now = new Date().toLocaleString();

            const txItem = document.createElement('div');
            txItem.className = 'flex flex-col md:flex-row justify-between items-center gap-3 p-3 border-b border-gray-700 last:border-0';
            txItem.innerHTML = `
                <div>
                    <p class="text-white font-medium">${amount}</p>
                    <p class="text-gray-500 text-sm">${now}</p>
                </div>
                <a href="${explorerUrl}" target="_blank" class="text-primary hover:text-primary/80 text-sm flex items-center gap-1">
                    <i class="fa fa-external-link"></i> ${txHash.slice(0, 8)}...
                </a>
            `;

            // æ’å…¥åˆ°è®°å½•åˆ—è¡¨é¡¶éƒ¨
            if (txHistory.textContent === 'æš‚æ— ææ¬¾è®°å½•') {
                txHistory.innerHTML = '';
            }
            txHistory.insertBefore(txItem, txHistory.firstChild);
        }
    </script>
</body>

</html>


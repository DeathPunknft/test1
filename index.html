<!DOCTYPE html>
<html>

<head lang="en">
    <link rel="icon" href="./favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="author" content="zhy" />
    <link rel="stylesheet" href="./Content/Styles/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" href="./Content/Styles/main.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="./Scripts/jQuery/jquery.min.js"></script>
    <script src="./Scripts/web3/web3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/merkletreejs@latest/merkletree.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keccak256@latest/keccak256.js"></script>

    <title>DA-AGE - Decentralized Asset NFT</title>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="body-bg-black">
                <div class="navBar text-center">
                    <div class="navBar-left">
                        <img src='./Content/Images/dan.png' />
                    </div>
                    <div class="navBar-right text-right">

                        <a href="javascript:void(0);" id="connect-wallet" class="nav-link">Connect Wallet</a>

                        <span id="tribe">Members:0</span>
                       
                        <ul>
                            <li>
                                <a href="https://twitter.com/" target="_blank" class="social-link">
                                    <img src='./Content/Images/twitter.png' width="20px" height="20px" />
                                </a>
                            </li>
                            <li>
                                <a href="https://discord.com/" target="_blank" class="social-link">
                                    <img src='./Content/Images/discord.png' width="20px" height="20px" />
                                </a>
                            </li>
                            <li>
                                <a href="http://youtube.com/" target="_blank" class="social-link">
                                    <img src='./Content/Images/youTube.png' width="20px" height="20px" />
                                </a>
                            </li>
                            <li>
                                <a href="https://telegram.org/" target="_blank" class="social-link">
                                    <img src='./Content/Images/telegram.png' width="20px" height="20px" />
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="detail-content">
                    <div class="detail-content-left">
                        <h1 class="heading">DA AGE NFT PRESALE!</h1>
                        <p class="subheading">Congratulations, you are one of the lucky few who made it to our WhiteList!
                            You are able to mint the NFTs at the price of 210USDT.</p>
                        <p class="subheading">Experience the thrill of the unknown! After you mint your NFT, you will have to wait for the big reveal to find out which prime location and zone you have landed. With numerous prime locations to choose from, the exact location and zone you receive will be a surprise. So, keep your fingers crossed and hope for the best!u'll receive. So, brace yourself and wish yourself the best of luck!.</p>    
                       
                        <br>
                        <div class="input-group">
                            <button type="button" class="btn minus-btn">-</button>
                            <input type="number" class="input-field qty-input" value="1" min="1" max="30">
                            <button type="button" class="btn plus-btn">+</button>
                        </div>
                        <br>

                        <button id="mint" type="button" class="primary-button w-button"
                            data-toggle="popover">mint</button>
                            <br>
                            <p class="subheading">MINT will start on May 8th, It's important to note that while NFT owners receive a portion of the profits, they will not have ownership rights to the physical asset itself, which remains with the asset owner.</p>

                    </div>



                    <div class="detail-content-right">
                        <img src='./Content/Images/1.gif' />
                    </div>

                </div>
            </div>
        </div>
    </div>


    </script>
</body>

</html>
<script type="text/javascript">

    const affiliateListAddress = [
        "0xbFd13AD0e134A40eaBE0562033e8Cf25a5785402",
        "0x46E1Df538821D8FED7B6EB1B68597d59B1BFC1b5",
        "0xfefd9e4939b1F4C6B66D60e7B4292cf042e6147E",
        "0x8f7daFe4CE278939F392CeB2D18C1Cc838258096",
        "0xc6342369b9FcA4aF1A9009b63D5d9656Ab02937D",
        "0x4bfBdb78D944CDc90665bB130fc555d49B8d4c0b",
        "0x4300016f3bBcAf6F79FBA5851a09f50048773592",
        "0x1F693D78D8048ce353765455e1cF8F45740c8a7F",
        "0x46Ee7e7873544b0eB07ad92e3379D0790C2e0A3B",
        "0x590BF69D8F67519C58891BA89fb1768819866A2a",
        "0xC7aadeDAA7caDc03e4858F522A3D2DA8123Ec9d9",
        "0x2c4071676bE3a8bFC78e38FA20a6D63ee90B3A4d",
        "0x22f64C3AffbB0bDE5D21527D14636b4586155417",
        "0xfC4962f2Ce5Fae2eedF285342B0631362CF4B696",
        "0x188AA630ED6CE2B3c31B7D50a6B1005779642eA6"
        ];

    var upperCaseAffiliateListAddress = [];

    for (var i = 0; i < affiliateListAddress.length; i++) {
        upperCaseAffiliateListAddress[i] = affiliateListAddress[i].toUpperCase();
    }

    const minusBtn = document.querySelector('.minus-btn');
    const plusBtn = document.querySelector('.plus-btn');
    const qtyInput = document.querySelector('.qty-input');


    minusBtn.addEventListener('click', function (event) {
        event.preventDefault();

        if (qtyInput.value > 1) {
            qtyInput.value--;
        }
    });

    plusBtn.addEventListener('click', function (event) {
        event.preventDefault();

        if (qtyInput.value < 10) {
            qtyInput.value++;
        }
    });

    var abi = [{
        "inputs": [
        {
            "internalType": "uint256",
            "name": "quantity",
            "type": "uint256"
        },
        {
            "internalType": "address",
            "name": "_referrer",
            "type": "address"
        }
        ],
        "name": "mint",
        "outputs": [],
        "stateMutability": "payable",
        "type": "function"
    },
    {
        "inputs":[
            {
                "internalType":"address",
                "name":"_referral",
                "type":"address"
            }
        ],
        "name":"getReferralSize",
        "outputs":[
            {
                "internalType":"uint256",
                "name":"",
                "type":"uint256"
            }
        ],
        "stateMutability":"view",
        "type":"function"
    }];

    var fee_token = {
        testnet: {
            address: "0xb35BF7873bF5e2A93FD2d35d14DAeFd186a7a489", // The address that the token is at.
            symbol: "USDT", // A ticker symbol or shorthand, up to 5 chars.
            decimals: 6, // The number of decimals in the token
            image: "https://polygonscan.com/token/images/tether_32.png", // A string url of the token logo
        },
        main: {
            address: "0xc2132D05D31c914a87C6611C10748AEb04B58e8F", // The address that the token is at.
            symbol: "USDT", // A ticker symbol or shorthand, up to 5 chars.
            decimals: 6, // The number of decimals in the token
            image: "https://polygonscan.com/token/images/tether_32.png", // A string url of the token logo
        },
    }

    var network = "main"; // network type
    var net_data_map = {
        testnet: {
            chainId: "0x13881",
            chainName: "Polygon Mumbai",
            nativeCurrency: {
                name: "MATIC",
                symbol: "MATIC",
                decimals: 18
            },
            rpcUrls: ["https://rpc.ankr.com/polygon_mumbai"],
            blockExplorerUrls: ["https://mumbai.polygonscan.com/"]
        },
        main: {
            chainId: "0x89",
            chainName: "Polygon Mainnet",
            nativeCurrency: {
                name: "MATIC",
                symbol: "MATIC",
                decimals: 18
            },
            rpcUrls: ["https://polygon.llamarpc.com"],
            blockExplorerUrls: ["https://polygonscan.com/"]
        }
    }
    var erc20Abi = [{ "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }];
    var contract = "0x9b5cc8939F1755CC4B901B00590C0a92C04D6a21";
    var mintFee = 1 * (10 ** fee_token[network].decimals) ; // mint fee
    const provider = window.ethereum || window.web3 || (window.bitkeep && window.bitkeep.ethereum);
    var web3 = new Web3(provider);
    var gasMultiple = 1.5;
    var gasMultiple1 = 1.3;

    
    var isConnect = window.localStorage.getItem("selectedWallet");
    var feeContract = new web3.eth.Contract(erc20Abi, fee_token[network].address);
    var walletPlaceholderText = "Connect Wallet";
    var wallet = new Proxy({ address: walletPlaceholderText }, {
        set(obj, prop, value) {
            if (prop === "address") {
                if (value && value != walletPlaceholderText) {

                   $("#connect-wallet").html(`${value.slice(0, 5)}...${value.slice(-5, value.length)}`);
                   
                   const index = refAddressAffiliateList(value.toUpperCase());

                    if(index != -1){

                        document.getElementById("tribe").style.display = "inline-block";
                        getReferralSize(wallet.address);
                    }
                  
                    
                } else {
                    $("#connect-wallet").html(walletPlaceholderText);
                    location.reload(true);
                }
            }
            if (prop == "chainId") {
                if (value !== net_data_map[network].chainId) {
                    if (["0x1", "0x2", "0x3", "0x4", "0x5"].includes(net_data_map[network].chainId)) {
                        // add ethereum chain switch
                        window.ethereum.request({
                            method: "wallet_switchEthereumChain",
                            "params": [
                                {
                                    "chainId": net_data_map[network].chainId,
                                }
                            ]
                        })
                    } else {
                        window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [net_data_map[network], wallet.address]
                        })
                            .then((result) => { })
                            .catch((error) => { })
                    }

                }

            }
            obj[prop] = value
        }
    });

    var mintBtn = new Proxy({ disable: false }, {
        set(obj, prop, value) {
            obj[prop] = value
        }
    });

    provider.on("accountsChanged", (accounts) => {
        wallet.address = accounts[0] || walletPlaceholderText;
    })

    provider.on('disconnect', (error) => {
        
        wallet.address = walletPlaceholderText
        
    });

    provider.on('chainChanged', (chainId) => {
        wallet.chainId = chainId;
        connectWallet(provider)
    });

    function connectWallet(provider) {

        provider.enable().then(async (accounts) => {
            wallet.address = accounts[0];
            wallet.chainId = provider.chainId;
            window.localStorage.setItem("selectedWallet", "INJECTED")
            await allowance(wallet.address);

            
            const index = refAddressAffiliateList(wallet.address.toUpperCase());

            if(index != -1){

                document.getElementById("tribe").style.display = "inline-block";
                getReferralSize(wallet.address);
            }

        }).catch(error => {
            console.log(error);
        });
    }

    async function allowance(address) {
        wallet.allowance = await feeContract.methods.allowance(address || wallet.address, contract).call();
        if (wallet.allowance < mintFee) {
            wallet.approve = false;
            $("#mint").text("Approve")
        } else {
            wallet.approve = true;
            $("#mint").text("Mint")
        }
    }


    async function approve() {
        
        let gasPrice = await web3.eth.getGasPrice();
        const data = feeContract.methods.approve(contract, mintFee).encodeABI();
        
        const gas = await web3.eth.estimateGas({
            from: wallet.address,
            to: fee_token[network].address,
            data
        })
        
        try {
            const result = await feeContract.methods.approve(contract, mintFee).send({
                from: wallet.address,
                to: fee_token[network].address,
                gasPrice: parseInt(gasPrice * gasMultiple),
                gas: parseInt(gas * gasMultiple)
            });
            wallet.approve = true;
            Toastify({
                text: "Approval successful",
                className: "info",
            }).showToast();
            await allowance();
        } catch (error) {
            
            console.log(error)
        }
    }

    async function getReferralSize(address){
        try {
            console.log("address = "+ address)
            let nftContract = new web3.eth.Contract(abi,contract);
            const result = await nftContract.methods.getReferralSize(address).call();
            console.log(result);
            document.getElementById("tribe").innerText = "Members:" + result;
        } catch (err) {
            console.error(err);
        }
    }
    

    $(function(){
    if (isConnect) {
        connectWallet(provider);
    };
    $("#connect-wallet").on("click",()=> {
        connectWallet(provider);
    });
    $("#mint").on("click", async ()=> {

        if (mintBtn.disable) return;

        mintBtn.disable = true;

        $("#mint").addClass("loading");
        
        if (!wallet.approve) {
            
            await approve();
            mintBtn.disable = false;
            $("#mint").removeClass("loading");
            return;
        }
        
        
        if (wallet.address === walletPlaceholderText) {
            connectWallet(provider)
            return;
        }
        
        let nftContract = new web3.eth.Contract(abi,contract);

        const input = document.querySelector('.input-field.qty-input');
        const mintValue = input.value;

        try {

            var ref = getQueryString("ref");

            const address = wallet.address;

            console.log("ref = " + ref);

            if(!isNotEmptyStr(ref)){

                alert("Affiliate cannot be null");
                mintBtn.disable = false;
                return;
            }

            const index = refAddressAffiliateList(ref.toUpperCase());

            if(index == -1){

                alert("Please fill in the correct affiliate address");
                mintBtn.disable = false;
                return;
            }
            
            
            let gasPrice = await web3.eth.getGasPrice();
            
            const data = nftContract.methods.mint(mintValue,ref).encodeABI();
            const gas = await web3.eth.estimateGas({
                from: wallet.address,
                to: contract,
                data
            })

           
            if (wallet.gasPrice && gasPrice < wallet.gasPrice) {
                gasPrice = wallet.gasPrice
            }

            var mintEth = mintFee * mintValue;
            
            nftContract.methods.mint(mintValue,ref).send({
                from: wallet.address,
                gasPrice: parseInt(gasPrice * gasMultiple1),
                gas: parseInt(gas * gasMultiple)
                
            }).then(async () => {
                mintBtn.disable = false;
                wallet.gasPrice = gasPrice; // save success gasPrice
                $("#mint").removeClass("loading");
                await allowance();
                Toastify({
                    text: "Mint successful",
                    className: "info",
                }).showToast();
            }).catch(async error=>{
                mintBtn.disable = false;
                $("#mint").removeClass("loading");
                await allowance();
            })
        } catch(error) {
            console.log(error, '--error')
            mintBtn.disable = false;
            $("#mint").removeClass("loading");
            await allowance();
        }
    })
    
    
})


    function refAddressAffiliateList(address) {

        var index = upperCaseAffiliateListAddress.indexOf(address);

        return index;

    }




 /*   $(function () {
        if (isConnect) {
            connectWallet(provider);
        };
        $("#connect-wallet").on("click", () => {
            connectWallet(provider);
        });
        $("#mint").on("click", async () => {

            if (wallet.address === walletPlaceholderText) {
                connectWallet(provider)
                return;
            }
            let nftContract = new web3.eth.Contract(abi, contract);

            try {

                let address = wallet.address.toUpperCase();
                let index = addressIsWL(address);
                if (index == -1) {
                    alert("not whitelist")
                    return;
                }

                let hexProof = getHexProof(index);

                if (!tree.verify(hexProof, leafNodes[index], root)) {
                    alert("not whitelist");
                    return;
                }

                const input = document.querySelector('.input-field.qty-input');
                const mintValue = input.value;

                var ref = getQueryString('ref');
                if (typeof ref === 'undefined' || ref === null) {
                    ref = wallet.address;
                }

                let gasPrice = await web3.eth.getGasPrice();
                
                if (wallet.gasPrice && gasPrice < wallet.gasPrice) {
                    gasPrice = wallet.gasPrice
                }
                var mintEth = 0.021 * mintValue;
                var ref = getQueryString("ref");
                if(!isNotEmptyStr(ref)){
                    ref = wallet.address;
                }
                nftContract.methods.mint(mintValue, ref).send({
                    from: wallet.address,
                    gasPrice: parseInt(gasPrice * gasMultiple),
                    value: web3.utils.toWei(mintEth.toString(), "ether")
                }).then(async () => {
                    mintBtn.disable = false;
                    wallet.gasPrice = gasPrice; // save success gasPrice
                    $("#mint").removeClass("loading");
                    await allowance();
                    Toastify({
                        text: "Mint successful",
                        className: "info",
                    }).showToast();
                }).catch(async error => {
                    console.log(error);
                })
            } catch (error) {
                
                console.log(error);
                
            }
        })


    })*/

    function getQueryString(name) {
        const url_string = document.location.toString();
        const url = new URL(url_string);
        console.log(url);
        return url.searchParams.get(name);
    }


    const whiteListAddress = [
        
    ];

    var upperCaseWL = [];

    for (var i = 0; i < whiteListAddress.length; i++) {
        upperCaseWL[i] = whiteListAddress[i].toUpperCase();
    }

    console.log(upperCaseWL)

    const leafNodes = whiteListAddress.map(addr => window.keccak256(addr));

    const tree = new window.MerkleTree(leafNodes, window.keccak256, { sortPairs: true });

    const root = tree.getHexRoot();

    function getHexProof(index) {
        return tree.getHexProof(leafNodes[index]);

    }

    function addressIsWL(address) {

        var index = upperCaseWL.indexOf(address);

        return index;

    }


function isNotEmptyStr(s) {
    if (typeof s == 'string' && s.length > 0) {
        return true
    }
    return false
}

</script>

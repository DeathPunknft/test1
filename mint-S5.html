<!DOCTYPE html>
<html>

<head lang="en">
    <link rel="icon" href="./favicon.ico">
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="author" content="zhy" />
    <link rel="stylesheet" href="./Content/Styles/mint.css">
    <link rel="stylesheet" href="./Content/Styles/main.css">
    <link rel="stylesheet" href="./Content/Styles/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script src="./Scripts/jQuery/jquery.min.js"></script>
    <script src="./Scripts/web3/web3.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/merkletreejs@latest/merkletree.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/keccak256@latest/keccak256.js"></script>

    <title>RWA-DA-AGE - Decentralized Asset</title>
</head>

<body>
    <div class="container-fluid">
        <div class="row">
            <div class="body-bg-black">
                <div class="navBar text-center">
                    <div class="navBar-left">
                        <a href="https://da-age.io/" target="_blank"><img src='./Content/Images/dan.png' /></a>
                    </div>
                    
                    <div class="navBar-right text-right">

                        <a href="javascript:void(0);" id="connect-wallet" class="nav-link">Connect Wallet</a>
                        <span id="count">MintPass:0</span>
                        <span id="tribe">Quantity:0</span>

                        
                    </div>
                </div>
                <div class="fn-section-4 wf-section">
                    <div class="fn-container-grid-2">
                        <div id="w-node-_61f80125-2bc5-ec0f-c12b-cc3b5c7923ed-305ff47e" class="fn-column-center-2">
                            <h1 class="title-da-age">S5 RWA DA AGE PRESALE!</h1>
                            <p class="fn-paragraph-2">Congratulations, you are one of the lucky few who made it to our
                                WhiteList!<br />You are able to mint the RWAs at the price of
                                320USDT.<br /><br />Experience the
                                thrill of the unknown! After you mint your RWA, you will have to wait for the big reveal
                                to find out
                                which prime location and zone you have landed. With numerous prime locations to choose
                                from, the
                                exact location and zone you receive will be a surprise. So, keep your fingers crossed
                                and hope for
                                the best!u&#x27;ll receive. So, brace yourself and wish yourself the best of
                                luck!<br /><br />‍</p>
                            
                        </div>
                        <div id="w-node-_61f80125-2bc5-ec0f-c12b-cc3b5c7923f8-305ff47e" class="fn-slide-item-wrapper">
                            <img id="w-node-_61f80125-2bc5-ec0f-c12b-cc3b5c7923f9-305ff47e" 
                                src="./Content/Images/RWA-S5.jpg"
                                loading="lazy"
                                
                                alt="" class="fn-slider-image" />
                            <div id="w-node-_61f80125-2bc5-ec0f-c12b-cc3b5c7923fa-305ff47e" class="fn-slider-column">
                                <h3 class="fn-heading-3">S5 RWA Mint</h3>
                                <h5 >Mint Price:</h5><br/>
                                <h5> 320 USDT</h5>
                                <div class="fn-label-icon"></div>
                                <div class="w-container">
                                    <h5>RWA unit</h5>
                                    <div class="input-group">
                                        <button type="button" class="btn minus-btn">-</button>
                                        <input type="number" class="input-field qty-input" value="1" min="1" max="30" disabled="disabled">
                                        <button type="button"  class="btn plus-btn">+</button>
                                    </div>
                                    <br>
                                </div>
                                <div class="fn-label-icon"></div>
                                <h5 >TOTAL: </h5><br/>
                                <h5 id="total">320 USDT</h5>
                                <div class="fn-label-icon"></div>
                                <button id="mint" type="button" class="primary-button w-button" data -toggle="popover">mint</button>
                                <p class="paragraph-7"><br />‍<br /><em class="italic-text">Ownership and Profit-Sharing: By participating in our profit-sharing model, 
                                    it is essential to understand that RWA holders do not acquire ownership rights to the physical assets involved. 
                                    The designated asset owner retains sole ownership of the assets. However, as an RWA holder, 
                                    you have the opportunity to receive profits over a duration of 8 years. 
                                    These profits enable you to partake in the earnings generated by the advertisement business, 
                                    providing a rewarding investment experience within the specified timeframe. 
                                    Please refer to the relevant agreements for comprehensive terms and conditions regarding the profit-sharing arrangement.</em></p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="footer wf-section">
                    <div class="footer-container w-container">
                        <div class="w-layout-grid footer-grid">
                            <div class="footer-main-box"><a data-ix="logo" href="https://da-age.io/" target="_blank"
                                    class="footer-logo w-nav-brand"><img
                                        src="https://uploads-ssl.webflow.com/6421898f81ec56cd303380ec/642d5a98952aaf152d2447d9_DAAGE_sss_sss.png"
                                        width="218" alt="" class="logo" /></a>
                                <p class="paragraph large grey">Own your digital assets in the age of decentralization -
                                    with DA AGE
                                    (Starting from 2023)</p>
                            </div>
                            <ul>
                                <li>
                                    <a href="https://twitter.com/DA_AGE_EN" target="_blank" class="social-link">
                                        <img src='./Content/Images/twitter.png' width="20px" height="20px" />
                                    </a>
                                </li>
                                <li>
                                    <a href="https://discord.com/invite/DA-AGE-Global" target="_blank" class="social-link">
                                        <img src='./Content/Images/discord.png' width="20px" height="20px" />
                                    </a>
                                </li>
    
                                <li>
                                    <a href="https://www.da-age.io/" target="_blank" class="social-link">
                                        <img src='./Content/Images/home.png' width="20px" height="20px" />
                                    </a>
                                </li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    </script>
</body>

</html>
<script type="text/javascript">

   
        const quantitySnapshotSizeMap = new Map();

    quantitySnapshotSizeMap.set("0x1A57Ed9204D53C415b7d247d16768b2525143229".toUpperCase(),18);

    quantitySnapshotSizeMap.set("0x42b5d149634e197693eaEE3727f510299d83C3E1".toUpperCase(),100);
    quantitySnapshotSizeMap.set("0x672928c361c6cE22c9CE32D5b8dc92841df1F997".toUpperCase(),1);
    quantitySnapshotSizeMap.set("0x7BE413d22018C1701E0048409808c27eB2f8a0E5".toUpperCase(),1);
    quantitySnapshotSizeMap.set("0x875eE36F382b6ebdFf8eFB4B14C966A68B96A6dA".toUpperCase(),21);
    quantitySnapshotSizeMap.set("0xA2E69eC4Cb49729258A03E712DAe1d79894B0097".toUpperCase(),1);
    quantitySnapshotSizeMap.set("0xa76348a9647fad19c002d7a9c3b4ba4f746a3474".toUpperCase(),3);
    quantitySnapshotSizeMap.set("0xe91c497578292eF54F46814971F413BbC0F1f558".toUpperCase(),17);
    quantitySnapshotSizeMap.set("0xfD4303fAe670E714Ff57c5cEB7532A74228225AA".toUpperCase(),6);

    const snapshotSizeMap = new Map();

    snapshotSizeMap.set("0xAC77719AA6486495cb56B360a0977eF07C66aB09".toUpperCase(),0);
    snapshotSizeMap.set("0x1C3fd3C20F3ca4cF4f3f58C6908F4A2aea42EEFA".toUpperCase(),0);
 var S2Abi = [
    {
        "inputs":[
            {
                "internalType":"address",
                "name":"",
                "type":"address"
            }
        ],
        "name":"referrersSize",
        "outputs":[
            {
                "internalType":"uint256",
                "name":"",
                "type":"uint256"
            }
        ],
        "stateMutability":"view",
        "type":"function"
    },
    {
        "inputs":[
            {
                "internalType":"uint256",
                "name":"_quantity",
                "type":"uint256"
            },
            {
                "internalType":"address",
                "name":"_referrer",
                "type":"address"
            }
        ],
        "name":"wlMint",
        "outputs":[

        ],
        "stateMutability":"payable",
        "type":"function"
    },
    {
        "inputs":[
            {
                "internalType":"uint256",
                "name":"_quantity",
                "type":"uint256"
            },
            {
                "internalType":"address",
                "name":"_referrer",
                "type":"address"
            }
        ],
        "name":"publicMint",
        "outputs":[

        ],
        "stateMutability":"payable",
        "type":"function"
    },
    {
        "inputs":[
            {
                "internalType":"address",
                "name":"",
                "type":"address"
            }
        ],
        "name":"theChiefaddr",
        "outputs":[
            {
                "internalType":"bool",
                "name":"",
                "type":"bool"
            }
        ],
        "stateMutability":"view",
        "type":"function"
    }
    ]
    var S2Contract = "0x291B1BD67eC8D1E194dB36d92B17823186b54F44";
    
    
    var abi = [
    {
        "inputs":[
            {
                "internalType":"address",
                "name":"",
                "type":"address"
            }
        ],
        "name":"referrersSize",
        "outputs":[
            {
                "internalType":"uint256",
                "name":"",
                "type":"uint256"
            }
        ],
        "stateMutability":"view",
        "type":"function"
    },
    {
        "inputs":[
            {
                "internalType":"uint256",
                "name":"_quantity",
                "type":"uint256"
            },
            {
                "internalType":"address",
                "name":"_referrer",
                "type":"address"
            }
        ],
        "name":"wlMint",
        "outputs":[

        ],
        "stateMutability":"payable",
        "type":"function"
    },
    {
        "inputs":[
            {
                "internalType":"uint256",
                "name":"_quantity",
                "type":"uint256"
            },
            {
                "internalType":"address",
                "name":"_referrer",
                "type":"address"
            }
        ],
        "name":"publicMint",
        "outputs":[

        ],
        "stateMutability":"payable",
        "type":"function"
    },
    {
        "inputs":[
            {
                "internalType":"address",
                "name":"",
                "type":"address"
            }
        ],
        "name":"theChiefaddr",
        "outputs":[
            {
                "internalType":"bool",
                "name":"",
                "type":"bool"
            }
        ],
        "stateMutability":"view",
        "type":"function"
    }
    ]
    var contract = "0xc1371489DD2b8bB69C54d8e02076200D40c61405"// S4 "0x129C7C4733b06190cCFEe1A515e0D4b4EDAD9725" //S3 "0xc0EBD15A80313dfd3e3fd3c36c15aDFA0ffba93F";//S2 "0x291B1BD67eC8D1E194dB36d92B17823186b54F44";//0x7E1d80417f1724f5Ff050C3F84DC9A3850B6e48f  main old

    var fee_token = {
        testnet: {
            address: "0xb35BF7873bF5e2A93FD2d35d14DAeFd186a7a489", // The address that the token is at.
            symbol: "USDT", // A ticker symbol or shorthand, up to 5 chars.
            decimals: 6, // The number of decimals in the token
            image: "https://polygonscan.com/token/images/tether_32.png", // A string url of the token logo
        },
        main: {       
            address: "0xc2132D05D31c914a87C6611C10748AEb04B58e8F", // The address that the token is at.
            symbol: "USDT", // A ticker symbol or shorthand, up to 5 chars.
            decimals: 6, // The number of decimals in the token
            image: "https://polygonscan.com/token/images/tether_32.png", // A string url of the token logo
        },
    }

    var network = "main"; // network type
    var net_data_map = {
        testnet: {
            chainId: "0x13881",
            chainName: "Polygon Mumbai",
            nativeCurrency: {
                name: "MATIC",
                symbol: "MATIC",
                decimals: 18
            },
            rpcUrls: ["https://rpc.ankr.com/polygon_mumbai"],
            blockExplorerUrls: ["https://mumbai.polygonscan.com/"]
        },
        main: {
            chainId: "0x89",
            chainName: "Polygon Mainnet",
            nativeCurrency: {
                name: "MATIC",
                symbol: "MATIC",
                decimals: 18
            },
            rpcUrls: ["https://polygon-mainnet.infura.io/v3/2af986a42abb45b5bd2c4495a3e0f6dd"],
            blockExplorerUrls: ["https://polygonscan.com/"]
        }
    }

    var erc20Abi = [{ "inputs": [{ "internalType": "address", "name": "owner", "type": "address" }, { "internalType": "address", "name": "spender", "type": "address" }], "name": "allowance", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "spender", "type": "address" }, { "internalType": "uint256", "name": "amount", "type": "uint256" }], "name": "approve", "outputs": [{ "internalType": "bool", "name": "", "type": "bool" }], "stateMutability": "nonpayable", "type": "function" }, { "inputs": [{ "internalType": "address", "name": "account", "type": "address" }], "name": "balanceOf", "outputs": [{ "internalType": "uint256", "name": "", "type": "uint256" }], "stateMutability": "view", "type": "function" }];

    
    var oldDaAgeContractABI = [
    {
        "inputs":[
            {
                "internalType":"address",
                "name":"_referral",
                "type":"address"
            }
        ],
        "name":"getReferralSize",
        "outputs":[
            {
                "internalType":"uint256",
                "name":"",
                "type":"uint256"
            }
        ],
        "stateMutability":"view",
        "type":"function"
    }
       
            ];

    var oldDaAgeContract = "0xf96E490e46A6eBC38e7C2B180ef2b0ED2481Efe6";
    
    var mintFee = 320 * (10 ** fee_token[network].decimals); // mint fee
    const provider = window.ethereum || window.web3 || (window.bitkeep && window.bitkeep.ethereum);
    var web3 = new Web3(provider);
    var gasMultiple = 1.1;//1.5;
    var gasMultiple1 = 1.1;//1.3;

    
    var isConnect = window.localStorage.getItem("selectedWallet");
    var feeContract = new web3.eth.Contract(erc20Abi, fee_token[network].address);
    var walletPlaceholderText = "Connect Wallet";
    var wallet = new Proxy({ address: walletPlaceholderText }, {
        set(obj, prop, value) {
            if (prop === "address") {
                if (value && value != walletPlaceholderText) {

                   $("#connect-wallet").html(`${value.slice(0, 5)}...${value.slice(-5, value.length)}`);
                   
                 /*  const index = refAddressAffiliateList(value.toUpperCase());
                   
                    if(index != -1){
                        console.log("wallet.address.value = " + value)
                        document.getElementById("tribe").style.display = "inline-block";
                        getReferralSize(value);
                        
                        
                    }*/

                    getMintPassBalanceOfSize(value);
                  
                    
                } else {
                    $("#connect-wallet").html(walletPlaceholderText);
                    location.reload(true);
                }
            }
            if (prop == "chainId") {
                if (value !== net_data_map[network].chainId) {
                    if (["0x1", "0x2", "0x3", "0x4", "0x5"].includes(net_data_map[network].chainId)) {
                        // add ethereum chain switch
                        window.ethereum.request({
                            method: "wallet_switchEthereumChain",
                            "params": [
                                {
                                    "chainId": net_data_map[network].chainId,
                                }
                            ]
                        })
                    } else {
                        window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [net_data_map[network], wallet.address]
                        })
                            .then((result) => { })
                            .catch((error) => { })
                    }

                }

            }
            obj[prop] = value
        }
    });

    var mintBtn = new Proxy({ disable: false }, {
        set(obj, prop, value) {
            obj[prop] = value
        }
    });

    provider.on("accountsChanged", (accounts) => {
        wallet.address = accounts[0] || walletPlaceholderText;
    })

    provider.on('disconnect', (error) => {
        
        wallet.address = walletPlaceholderText
        
    });

    provider.on('chainChanged', (chainId) => {
        wallet.chainId = chainId;
        connectWallet(provider)
    });

    function connectWallet(provider) {

        provider.enable().then(async (accounts) => {
            wallet.address = accounts[0];
            wallet.chainId = provider.chainId;
            window.localStorage.setItem("selectedWallet", "INJECTED")
            await allowance(wallet.address);

            await getMintPassBalanceOfSize(wallet.address);

            const type = await addresIsAffiliateList(wallet.address);
                   
            if(type){
                
                console.log("wallet.address = " + wallet.address)
                document.getElementById("tribe").style.display = "inline-block";

                await getReferralSize(wallet.address);
                

            }

            

        }).catch(error => {
            console.log(error);
        });
    }

    async function allowance(address) {
        wallet.allowance = await feeContract.methods.allowance(address || wallet.address, contract).call();
        if (wallet.allowance < mintFee) {
            wallet.approve = false;
            $("#mint").text("Approve")
        } else {
            wallet.approve = true;
            $("#mint").text("Mint")
        }
    }


    async function approve() {

        let gasPrice = await web3.eth.getGasPrice();
        
        const data = feeContract.methods.approve(contract, mintFee).encodeABI();
        
        const gas = await web3.eth.estimateGas({
            from: wallet.address,
            to: fee_token[network].address,
            data
        })
        
        try {
            const input = document.querySelector('.input-field.qty-input');
            const mintValue = input.value;
            mintFee = mintValue * mintFee;
            const result = await feeContract.methods.approve(contract, mintFee).send({
                from: wallet.address,
                to: fee_token[network].address,
                gasPrice: parseInt(gasPrice * gasMultiple),
                gas: parseInt(gas * gasMultiple)
            });
            wallet.approve = true;
            Toastify({
                text: "Approval successful",
                className: "info",
            }).showToast();
            await allowance();
        } catch (error) {
            
            console.log(error)
        }
    }


    const minusBtn = document.querySelector('.minus-btn');
    const plusBtn = document.querySelector('.plus-btn');
    const qtyInput = document.querySelector('.qty-input');


    minusBtn.addEventListener('click', function (event) {
        event.preventDefault();

        if (qtyInput.value > 1) {
            qtyInput.value--;
            setTotal(qtyInput.value);
        }
    });

    plusBtn.addEventListener('click', async function (event) {
        event.preventDefault();

        if (qtyInput.value < 30) {
            qtyInput.value++;
            setTotal(qtyInput.value);
        }
    });

    function setTotal(value){
        var totalElement = document.getElementById("total");
        var newValue = 320 * value;
        totalElement.innerHTML = newValue + " USDT";
    }

    async function getMintPassBalanceOf(address){

      var mintPassAbi = [{
            "inputs":[
                {
                    "internalType":"address",
                    "name":"owner",
                    "type":"address"
                }
            ],
            "name":"balanceOf",
            "outputs":[
                {
                    "internalType":"uint256",
                    "name":"",
                    "type":"uint256"
                }
            ],
            "stateMutability":"view",
            "type":"function"
        }];

      var mintPassContractAddress = "0x7eCD83DbDF27c07221CceAd6837B3e76CDC858F9" //s4 "0xE37c815F1726Ad82B87cA737d454a6A6ec9047A2" //S3 "0xe596B26F8014135F01412f5eaE6582Be1C310Bc0"; //old main "0x1B635CC32B58F12922cc41b7574Badd36BD7E0A8";//"0x3B56B4F6173Adf44e56A404535a91bc6abEAf97D";// test"0xFC6d5fead2Af77A4C76d26cF2EffaA422da36062";//"0xFC6d5fead2Af77A4C76d26cF2EffaA422da36062";
      var result = 0;  
      
      try {
            
            var mintPassContracQuery = new web3.eth.Contract(mintPassAbi, mintPassContractAddress);
            
            result = await mintPassContracQuery.methods.balanceOf(address).call();
            console.log("mintPass = ",result)
            return result;
           
        } catch (err) {
            console.log(err);
        }
        
        return result;

    }

    async function getMintPassBalanceOfSize(address){
        try {
          var result = 0;
          
          result = await getMintPassBalanceOf(address);
          console.log("mintPass = ",result)
          document.getElementById("count").innerText = "MintPass:" + result;
           
        } catch (err) {
            console.log(err);
        }
    }



   async function getReferralSize(address){
        try {
            
            const contractQuery = new web3.eth.Contract(abi, contract);

            var result = 0;
            
            result = await contractQuery.methods.referrersSize(address).call();

          /*  
            var oldDaAgeResult = 0;

            const oldDaAgeContractQuery = new web3.eth.Contract(oldDaAgeContractABI, oldDaAgeContract);

            oldDaAgeResult = await oldDaAgeContractQuery.methods.getReferralSize(address).call();
            
            const oldS1DaAgeContract = "0x7E1d80417f1724f5Ff050C3F84DC9A3850B6e48f";

            const oldS1DaAgeContractQuery = new web3.eth.Contract(abi, oldS1DaAgeContract);

            var oldS1DaAgeResult = 0;

            oldS1DaAgeResult = await oldS1DaAgeContractQuery.methods.referrersSize(address).call();



            const oldS2DaAgeContract = "0x291B1BD67eC8D1E194dB36d92B17823186b54F44";

            const oldS2DaAgeContractQuery = new web3.eth.Contract(S2Abi, S2Contract);

            var oldS2DaAgeResult = 0;

            oldS2DaAgeResult = await oldS2DaAgeContractQuery.methods.referrersSize(address).call();


            

            const oldS3DaAgeContract = "0xc0EBD15A80313dfd3e3fd3c36c15aDFA0ffba93F";

            const oldS3DaAgeContractQuery = new web3.eth.Contract(S2Abi, oldS3DaAgeContract);

            var oldS3DaAgeResult = 0;

            oldS3DaAgeResult = await oldS3DaAgeContractQuery.methods.referrersSize(address).call();


            const oldS4DaAgeContract = "0x129C7C4733b06190cCFEe1A515e0D4b4EDAD9725";

            const oldS4DaAgeContractQuery = new web3.eth.Contract(S2Abi, oldS4DaAgeContract);

            var oldS4DaAgeResult = 0;

            oldS4DaAgeResult = await oldS4DaAgeContractQuery.methods.referrersSize(address).call();


            var sum = parseInt(result) + parseInt(oldDaAgeResult) + parseInt(oldS1DaAgeResult) + parseInt(oldS2DaAgeResult) + parseInt(oldS3DaAgeResult) + parseInt(oldS4DaAgeResult);

            console.log(result + oldDaAgeResult + oldS2DaAgeResult +  oldS3DaAgeResult);

            */

            var snapshotSize =  quantitySnapshotSizeMap.get(address.toUpperCase());

            if (typeof snapshotSize === 'number') {
                result = parseInt(result) + parseInt(snapshotSize);
            }

            var sum = result;
            console.log('sum = ' +sum);

            document.getElementById("tribe").innerText = "Quantity:" + sum;

            return result;
            
           
        } catch (err) {
            console.log(err);
        }
    }


    
    
    

    $(function(){
    if (isConnect) {
        connectWallet(provider);
    };
    $("#connect-wallet").on("click",()=> {
        connectWallet(provider);
    });
    $("#mint").on("click", async ()=> {

        
        //is maximum number of affiliate members
        let nftContract = new web3.eth.Contract(abi,contract);
        
      /*  var mintPassBalanceOf = 0;
        
        mintPassBalanceOf = await getMintPassBalanceOf(wallet.address);

        console.log("mintPassBalanceOf===",mintPassBalanceOf);

        mintPassBalanceOf = Number(mintPassBalanceOf);

        if(mintPassBalanceOf <= 0){
            alert("approve error,your wallet not mintPass");
            mintBtn.disable = false;
            return;
        }

        
        if(mintPassBalanceOf < mintValueNumber){
            alert("Please reduce the amount of mint, your wallet does not have so many MintPass");
            mintBtn.disable = false;
            return;
        } */
        
        var input = document.querySelector('.input-field.qty-input');
        var mintValue = input.value;
        var mintValueNumber = Number(mintValue);
        console.log("mintValue=",mintValueNumber)
        

        
        var ref = getQueryString("ref");

        console.log("ref = " + ref);

        if(!isNotEmptyStr(ref)){

            alert("Affiliate cannot be null");
            
            return;
        }

    
     /*   let isMatch = false;
        
        for (let i = 0; i < upperCaseAffiliateListAddress.length; i++) {
            
            if (ref.toUpperCase() === upperCaseAffiliateListAddress[i].substring(0,30)) {
                    isMatch = true;
                    let index = upperCaseAffiliateListAddress[i];
                    ref = affiliateListAddress[i];
                    break;
                }
            }
        
        if(!isMatch){

            alert("Please fill in the correct affiliate address");
            mintBtn.disable = false;
            return;
        }*/


        var addressRef = await queryAddressQuota(ref);

        console.log("addressRef.ref" + addressRef.data)

        if(addressRef.data === undefined){

            alert("Affiliate cannot be null");
            
            return;
        }

        
        ref = addressRef.data.ref;

        console.log("ref=" + ref)

        const resultAddress = isAddressInArray(addressNoList, ref);

        console.log("result+",resultAddress)

        if(resultAddress){
            alert('The number of RWA  issued by chain shop associated with the wallet address has exceeded 500, reaching the upper limit of Stage S5. As a result, the RWA issuance function for the chain shop will be disabled.'); 
            return;
        }

        if(addressRef.data.mintMax != '-1'){

            var boolType = await nftContract.methods.theChiefaddr(wallet.address).call();


            console.log("boolType",boolType);

            //address value is RWA-DA-AGE theChiefa

            if(boolType){

            alert("address is RWA-DA-AGE theChiefa, Please submit using a different address");
            return;
            }

        }
        

        if(snapshotSizeMap.has(ref)){

            let resultSize = 0;
            resultSize = await nftContract.methods.referrersSize(ref).call();
    
            let snapshotSize = 0;
            snapshotSize = snapshotSizeMap.get(ref);
    
            console.log("resultSize ="  + resultSize);
            console.log("snapshotSize ="  + snapshotSize);
    
            resultSize = resultSize - snapshotSize;
            console.log("resultSize ="  + resultSize);
            let size = 0;
            size = addressRef.data.mintMax;
            var result = Number(resultSize);
            var mintNumber = Number(mintValue);
            console.log("size ="  + size);
            console.log("(resultSize + mintValue)"  + (result+ mintNumber));
            
            
            if((result+ mintNumber) > size){
    
                alert("Affiliate members have reached the maximum number");
                mintBtn.disable = false;
                return;
            }
        }
        

        

        if (mintBtn.disable) return;

        mintBtn.disable = true;

        
        
        $("#mint").text("loading");
       
        if (!wallet.approve) {
            
            await approve();
            
            mintBtn.disable = false;
            $("#mint").text("Mint");
            return;
        }
        
        
        if (wallet.address === walletPlaceholderText) {
            connectWallet(provider)
            return;
        }
        
       
        
        try {
            
            let gasPrice = await web3.eth.getGasPrice();
            
            const data = nftContract.methods.wlMint(mintValue,ref).encodeABI();
            
            const gas = await web3.eth.estimateGas({
                from: wallet.address,
                to: contract,
                data
            })

           
            if (wallet.gasPrice && gasPrice < wallet.gasPrice) {
                gasPrice = wallet.gasPrice
            }

            var mintEth = mintFee * mintValue;
            
            const estimatedGas = await nftContract.methods.wlMint(mintValue, ref).estimateGas({from: wallet.address});

            nftContract.methods.wlMint(mintValue,ref).send({
                from: wallet.address,   
                gasPrice: parseInt(gasPrice * gasMultiple1),
                gas: parseInt(gas * gasMultiple)
                
            }).then(async () => {
                mintBtn.disable = false;
                wallet.gasPrice = gasPrice; // save success gasPrice
                $("#mint").text("Mint");
                await allowance();
                alert("Mint successful");
                Toastify({
                    text: "Mint successful",
                    className: "info",
                }).showToast();
            }).catch(async error=>{
                mintBtn.disable = false;
                $("#mint").text("Mint");
                await allowance();
            })
        } catch(error) {
            console.log(error, '--error')
            mintBtn.disable = false;
            $("#mint").text("Mint");
            await allowance();
        }
    })
    
    
})

    function refIsAffiliateAddressList(ref){

        let isMatch = false;

        for (let i = 0; i < upperCaseAffiliateListAddress.length; i++) {

        if (shortenedEthAddress.startsWith(upperCaseAffiliateListAddress[i])) {
                isMatch = true;
                break;
            }
        }

        return isMatch;
    }

    


    function refAddressAffiliateList(address) {

        var index = upperCaseAffiliateListAddress.indexOf(address);

        return index;

    }


    async function addresIsAffiliateList(value){

        var data = await queryAddressQuota(value);

        if(data === undefined){
            
            return false;
        }

        if(data.code === 200){
            return true;
        }

        return false;
    }

 

    function getQueryString(name) {
        const url_string = document.location.toString();
        const url = new URL(url_string);
        console.log(url);
        return url.searchParams.get(name);
    }


    function isNotEmptyStr(s) {
        if (typeof s == 'string' && s.length > 0) {
            return true
        }
        return false
    }

    async function queryAddressQuota(ref) {
        try {
            let response = await fetch('https://i-t-p.io/third/query/nftOperator', {
                method: 'POST', 
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({'address': ref})
            });
            let data = await response.json();
            console.log(data)
            if(data.code == 200){
                return data;
            }
           
        } catch (error) {
            console.error('Error:', error);
            return null;
        }
    }

     const addressNoList = ['0x671755011d43558C70b0cc795db23BE7E13D4959', '0x24F7a7e7C1E91490f3c1e34F8b58658A5D551A1A','0xdF3a424D71a723B3B7fe0169DDE4815A9be9fb93'];//'0x46E1Df538821D8FED7B6EB1B68597d59B1BFC1b5', 

    function isAddressInArray(addressArray, addressToCheck) {

        return addressArray.includes(addressToCheck);
    }
    

</script>
